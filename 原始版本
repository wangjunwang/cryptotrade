/**
 * è¯¾æ—¶è®° (Class Recorder) - UI ç²¾ä¿®ç‰ˆ
 * * ä¿®æ”¹æ—¥å¿—ï¼š
 * 1. é¦–é¡µé‡æ„ï¼šé¡¶éƒ¨å·¦ä¾§å¤§æ ‡é¢˜ï¼Œæœˆä»½åˆ‡æ¢å±…ä¸­ï¼Œæ ·å¼å¯¹é½å›¾1ã€‚
 * 2. è¯¦æƒ…é¡µé‡æ„ï¼šå¢åŠ å…³é—­æŒ‰é’®ï¼Œä¼˜åŒ–æ“ä½œæŒ‰é’®ä¸ºåŒåˆ—å¤§å¡ç‰‡ï¼Œæ—¶é—´è½´æ ·å¼å¯¹é½å›¾2ã€‚
 * 3. å¼¹çª—ä¿®å¤ï¼šä¿®å¤æ·»åŠ å­¦ç”Ÿå¼¹çª—çœ‹ä¸æ¸…è¾“å…¥æ¡†çš„é—®é¢˜ï¼Œå¢åŠ æ˜ç¡®æ ‡é¢˜å’ŒæŒ‰é’®æ ·å¼ã€‚
 * 4. é€»è¾‘ä¼˜åŒ–ï¼šçµæ„Ÿå½’å±åˆ°å…·ä½“æ—¥æœŸï¼Œåœ¨æ—¥ç¨‹åˆ—è¡¨ä¸­å±•ç¤ºã€‚
 * 5. ç¼–è¯‘ä¿®å¤ï¼šä¿®å¤ overlay ç±»å‹é”™è¯¯ï¼ˆæ”¹ç”¨ Stackï¼‰å’Œ FontWeight.Light é”™è¯¯ï¼ˆæ”¹ä¸º Lighterï¼‰ã€‚
 */

import promptAction from '@ohos.promptAction';
import notificationManager from '@ohos.notificationManager';
import notification from '@ohos.notification';

// --- 1. æ•°æ®æ¨¡å‹å®šä¹‰ ---
class Student {
  id: number = 0;
  name: string = '';
  totalHours: number = 0;
  remainingHours: number = 0;
  paymentDate: string = '';
  note: string = '';

  constructor(name: string, totalHours: number, note: string) {
    this.id = Date.now();
    this.name = name;
    this.totalHours = totalHours;
    this.remainingHours = totalHours;
    this.paymentDate = new Date().toISOString().split('T')[0];
    this.note = note;
  }
}

class CalendarEvent {
  id: number = 0;
  date: string = '';
  type: 'class' | 'inspiration' = 'class';
  studentId: number | null = null;
  content: string = '';
  time: string = '';
  status: 'scheduled' | 'completed' = 'scheduled';

  constructor(type: 'class' | 'inspiration', date: string) {
    this.id = Date.now();
    this.type = type;
    this.date = date;
  }
}

// åˆå§‹åŒ–æŒä¹…åŒ–æ•°æ®
PersistentStorage.PersistProp('students_data', []);
PersistentStorage.PersistProp('events_data', []);

// --- 2. ä¸šåŠ¡é€»è¾‘ï¼šé€šçŸ¥æœåŠ¡ ---
class NotificationService {
  static readonly NOTIFICATION_ID = 1001;

  static async startClassReminder(studentName: string, time: string) {
    try {
      await notificationManager.requestEnableNotification();
      let notificationRequest: notificationManager.NotificationRequest = {
        id: NotificationService.NOTIFICATION_ID,
        slotType: notification.SlotType.SOCIAL_COMMUNICATION,
        content: {
          contentType: notification.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: `å³å°†ä¸Šè¯¾ï¼š${studentName}`,
            text: `æ—¶é—´ï¼š${time} | è¯·åšå¥½ä¸Šè¯¾å‡†å¤‡`,
            additionalText: "è¯¾æ—¶è®°æé†’"
          }
        },
        extraInfo: {
          "studentName": studentName,
          "classTime": time
        }
      };
      await notificationManager.publish(notificationRequest);
      try { promptAction.showToast({ message: 'å·²å‘é€ä¸Šè¯¾æé†’é€šçŸ¥' }); } catch (e) {}
    } catch (err) {
      console.error(`å‘å¸ƒé€šçŸ¥å¤±è´¥: ${JSON.stringify(err)}`);
      try { promptAction.showToast({ message: 'é€šçŸ¥å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™' }); } catch (e) {}
    }
  }
}

// --- 3. UI ç»„ä»¶ ---

// å¼¹çª—æ ·å¼ç»„ä»¶
@CustomDialog
struct AddDialog {
  controller: CustomDialogController;
  type: 'class' | 'inspiration' | 'student_add' = 'class';
  @Link students: Student[];
  @Link events: CalendarEvent[];
  selectedDate: Date = new Date();

  @State nameInput: string = '';
  @State hoursInput: string = '';
  @State noteInput: string = '';
  @State selectedStudentId: number = -1;
  @State timeInput: string = '14:00';
  @State contentInput: string = '';

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Text(this.type === 'class' ? 'æ’ä¸€èŠ‚è¯¾' : (this.type === 'inspiration' ? 'è®°å½•çµæ„Ÿ' : 'æ–°å¢å­¦ç”Ÿ'))
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 24 })
        .width('100%')
        .textAlign(TextAlign.Center)

      if (this.type === 'student_add') {
        // å­¦ç”Ÿæ·»åŠ è¡¨å•
        Column({ space: 16 }) {
          this.buildInput('å­¦ç”Ÿå§“å', (val: string) => this.nameInput = val)
          this.buildInput('è´­ä¹°è¯¾æ—¶', (val: string) => this.hoursInput = val, InputType.Number)
          this.buildInput('å¤‡æ³¨ (é€‰å¡«)', (val: string) => this.noteInput = val)
        }
      } else if (this.type === 'class') {
        // æ’è¯¾è¡¨å•
        Column({ space: 16 }) {
          Text('é€‰æ‹©å­¦ç”Ÿ').fontSize(14).fontColor('#64748B').width('100%')
          if (this.students.length === 0) {
            Text('æš‚æ— å­¦ç”Ÿæ•°æ®ï¼Œè¯·å…ˆå»â€œå­¦ç”Ÿâ€é¡µæ·»åŠ ').fontColor('#2563EB').fontSize(14)
          } else {
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.students, (s: Student) => {
                Text(s.name)
                  .fontSize(14)
                  .fontColor(this.selectedStudentId === s.id ? Color.White : '#64748B')
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .backgroundColor(this.selectedStudentId === s.id ? '#2563EB' : '#F3F4F6')
                  .borderRadius(20)
                  .margin({ right: 10, bottom: 10 })
                  .onClick(() => this.selectedStudentId = s.id)
              })
            }
          }
          this.buildInput('æ—¶é—´ (ä¾‹å¦‚ 14:00)', (val: string) => this.timeInput = val, InputType.Normal, this.timeInput)
        }
      } else {
        // çµæ„Ÿè¡¨å•
        TextArea({ placeholder: 'å†™ä¸‹ä½ çš„æƒ³æ³•...' })
          .height(120)
          .backgroundColor('#F3F4F6')
          .borderRadius(16)
          .onChange((val: string) => this.contentInput = val)
          .padding(16)
      }

      // åº•éƒ¨æŒ‰é’®åŒº
      Row({ space: 16 }) {
        Button('å–æ¶ˆ')
          .backgroundColor('#F3F4F6')
          .fontColor('#64748B')
          .layoutWeight(1)
          .height(44)
          .onClick(() => this.controller.close())

        Button('ç¡®è®¤')
          .backgroundColor('#2563EB')
          .fontColor(Color.White)
          .layoutWeight(1)
          .height(44)
          .onClick(() => this.handleSubmit())
      }
      .margin({ top: 32 })
      .width('100%')
    }
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(24)
    .width('90%') // ç¨å¾®å®½ä¸€ç‚¹
  }

  // å°è£…è¾“å…¥æ¡†ï¼Œç¡®ä¿èƒŒæ™¯è‰²å¯è§
  @Builder buildInput(placeholder: string, onChange: (val: string) => void, type: InputType = InputType.Normal, defaultVal?: string) {
    TextInput({ placeholder: placeholder, text: defaultVal })
      .type(type)
      .backgroundColor('#F3F4F6') // æµ…ç°èƒŒæ™¯ï¼Œç¡®ä¿åœ¨ç™½åº•ä¸Šå¯è§
      .placeholderColor('#9CA3AF')
      .borderRadius(12)
      .height(50)
      .padding({ left: 16 })
      .onChange(onChange)
      .width('100%')
  }

  handleSubmit() {
    if (this.type === 'student_add') {
      if (!this.nameInput) {
        try { promptAction.showToast({ message: 'è¯·è¾“å…¥å§“å' }); } catch(e){}
        return;
      }
      this.students.push(new Student(this.nameInput, parseInt(this.hoursInput) || 0, this.noteInput));
    } else if (this.type === 'class') {
      if (this.selectedStudentId === -1) {
        try { promptAction.showToast({ message: 'è¯·é€‰æ‹©å­¦ç”Ÿ' }); } catch(e){}
        return;
      }
      const evt = new CalendarEvent('class', this.selectedDate.toISOString().split('T')[0]);
      evt.studentId = this.selectedStudentId;
      evt.time = this.timeInput;
      this.events.push(evt);
    } else {
      if (!this.contentInput) return;
      const evt = new CalendarEvent('inspiration', this.selectedDate.toISOString().split('T')[0]);
      evt.content = this.contentInput;
      this.events.push(evt);
    }
    this.controller.close();
  }
}

@Entry
@Component
struct ClassRecorderApp {
  @StorageLink('students_data') students: Student[] = [];
  @StorageLink('events_data') events: CalendarEvent[] = [];

  // é¡µé¢æ§åˆ¶çŠ¶æ€
  @State currentTabIndex: number = 0;
  private tabsController: TabsController = new TabsController();

  @State currentDate: Date = new Date();
  @State selectedDate: Date = new Date();
  @State isSheetShown: boolean = false;
  @State dialogType: 'class' | 'inspiration' | 'student_add' = 'class';

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddDialog({ type: this.dialogType, students: $students, events: $events, selectedDate: this.selectedDate }),
    alignment: DialogAlignment.Center,
    customStyle: true,
    autoCancel: true
  });

  openDialog(type: 'class' | 'inspiration' | 'student_add') {
    this.dialogType = type;
    this.dialogController.open();
  }

  getDaysInMonth(date: Date): (Date | null)[] {
    const year = date.getFullYear();
    const month = date.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay();
    const days: (Date | null)[] = [];
    for (let i = 0; i < firstDayIndex; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
    return days;
  }

  formatDate(date: Date): string { return date.toISOString().split('T')[0]; }
  getEventsForDay(date: Date | null): CalendarEvent[] {
    if (!date) return [];
    return this.events.filter(e => e.date === this.formatDate(date));
  }

  // --- é¦–é¡µæ—¥å†è§†å›¾ (å¤åˆ»å›¾1) ---
  @Builder CalendarView() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('è¯¾æ—¶è®°')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#111827')

        // ç”¨æˆ·å¤´åƒå ä½ç¬¦ - ä¿®å¤ï¼šä½¿ç”¨ Stack æ›¿ä»£ overlayï¼Œè§£å†³ç±»å‹é”™è¯¯
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 40, height: 40 })
            .fill('#F3F4F6')
          Text('User')
            .fontSize(10)
            .fontColor('#9CA3AF')
        }
        .width(40)
        .height(40)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 24, right: 24, top: 20, bottom: 10 })

      // 2. æœˆä»½åˆ‡æ¢å™¨ (å±…ä¸­)
      Row() {
        Button('<').type(ButtonType.Normal).backgroundColor(Color.Transparent).fontColor('#6B7280').onClick(() => this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1))

        Column() {
          Text(`${this.currentDate.getMonth() + 1}æœˆ`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#111827')
          Text(`${this.currentDate.getFullYear()}`)
            .fontSize(12)
            .fontColor('#9CA3AF')
            .letterSpacing(1)
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20, right: 20 })

        Button('>').type(ButtonType.Normal).backgroundColor(Color.Transparent).fontColor('#6B7280').onClick(() => this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1))
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: 10, bottom: 20 })

      // 3. æ˜ŸæœŸå¤´
      Flex({ justifyContent: FlexAlign.SpaceAround }) {
        ForEach(['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'], (day: string) => {
          Text(day).fontSize(12).fontColor('#9CA3AF').fontWeight(FontWeight.Medium)
        })
      }
      .padding({ left: 10, right: 10 })
      .margin({ bottom: 10 })

      // 4. æ—¥æœŸç½‘æ ¼
      Grid() {
        ForEach(this.getDaysInMonth(this.currentDate), (date: Date | null) => {
          GridItem() {
            if (date) {
              Column() {
                // æ—¥æœŸæ•°å­—
                Text(`${date.getDate()}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.formatDate(date) === this.formatDate(new Date()) ? Color.White : '#1F2937')
                  .width(40)
                  .height(40)
                  .textAlign(TextAlign.Center)
                  .borderRadius(20)
                  .backgroundColor(this.formatDate(date) === this.formatDate(new Date()) ? '#2563EB' : Color.Transparent)

                // äº‹ä»¶ç‚¹ç‚¹
                Row({ space: 4 }) {
                  if (this.getEventsForDay(date).some(e => e.type === 'class')) Circle({ width: 5, height: 5 }).fill('#3B82F6')
                  if (this.getEventsForDay(date).some(e => e.type === 'inspiration')) Circle({ width: 5, height: 5 }).fill('#F97316')
                }.margin({ top: 4 })
              }
              .height(64)
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .onClick(() => {
                this.selectedDate = date;
                this.isSheetShown = true;
              })
            }
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr')
      .rowsGap(8)
      .padding({ left: 10, right: 10 })
      .layoutWeight(1) // è®©æ—¥å†å æ®å‰©ä½™ç©ºé—´

      // 5. ä»Šæ—¥æ¦‚è§ˆå¡ç‰‡
      Row() {
        Column() {
          Text('ä»Šæ—¥æ¦‚è§ˆ').fontSize(12).fontColor('#3B82F6').fontWeight(FontWeight.Bold).margin({ bottom: 4 })
          Text(`${this.getEventsForDay(new Date()).length} é¡¹æ—¥ç¨‹`).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#1F2937')
        }
        .alignItems(HorizontalAlign.Start)

        // ç®€å•å›¾æ ‡
        Image($r('app.media.icon')).width(40).height(40).objectFit(ImageFit.Contain).opacity(0.8)
          .onError(() => {}) // é˜²æ­¢æ— å›¾æŠ¥é”™
      }
      .width('90%')
      .backgroundColor('#EFF6FF')
      .borderRadius(20)
      .padding(24)
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 20 })
    }
    .height('100%')
    .backgroundColor(Color.White)
  }

  // --- å­¦ç”Ÿç®¡ç†è§†å›¾ ---
  @Builder StudentsView() {
    Column() {
      Row() {
        Text('å­¦ç”Ÿç®¡ç†').fontSize(24).fontWeight(FontWeight.Bold)
        Button('+ æ–°å¢').height(36).fontSize(14).backgroundColor('#2563EB').onClick(() => this.openDialog('student_add'))
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 24, right: 24, top: 20, bottom: 20 })

      List({ space: 12 }) {
        ForEach(this.students, (student: Student, index: number) => {
          ListItem() {
            Row() {
              // å¤´åƒ
              Text(student.name.substring(0, 1))
                .width(48)
                .height(48)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .textAlign(TextAlign.Center)
                .fontColor('#4B5563')
                .backgroundColor('#F3F4F6')
                .borderRadius(24)
                .margin({ right: 16 })

              Column() {
                Row() {
                  Text(student.name).fontSize(16).fontWeight(FontWeight.Bold)
                  if (student.remainingHours <= 3) {
                    Text('ä½™é¢ä¸è¶³').fontSize(10).fontColor('#DC2626').backgroundColor('#FEE2E2').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(4).margin({ left: 8 })
                  }
                }
                Text(student.note || 'æ— å¤‡æ³¨').fontSize(12).fontColor('#9CA3AF').margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              Column() {
                Text('å‰©ä½™').fontSize(10).fontColor('#9CA3AF')
                Text() {
                  Span(`${student.remainingHours}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(student.remainingHours <= 3 ? '#EF4444' : '#2563EB');
                  Span(` / ${student.totalHours}`).fontSize(12).fontColor('#9CA3AF')
                }
              }
            }
            .padding(16)
            .width('100%')
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.03)', offsetY: 4 })
          }
          .swipeAction({ end: this.DeleteAction(index, 'student') })
        })
      }
      .width('100%').padding({ left: 16, right: 16, bottom: 100 }).layoutWeight(1)
    }
    .height('100%').backgroundColor('#F9FAFB') // åˆ—è¡¨é¡µç»™ä¸€ç‚¹æ·¡ç°èƒŒæ™¯
  }

  // --- çµæ„Ÿè§†å›¾ (å…¨é‡åˆ—è¡¨) ---
  @Builder InspirationsView() {
    Column() {
      Row() {
        Text('çµæ„Ÿåº“').fontSize(24).fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 20, bottom: 20 })

      List({ space: 12 }) {
        ForEach(this.events.filter(e => e.type === 'inspiration'), (item: CalendarEvent) => {
          ListItem() {
            Column() {
              Text(item.content).fontSize(15).fontColor('#374151').lineHeight(24).width('100%')
              Row() {
                Text(item.date).fontSize(12).fontColor('#9CA3AF')
              }
              .width('100%')
              .justifyContent(FlexAlign.End)
              .margin({ top: 12 })
            }
            .padding(20)
            .backgroundColor('#FFF7ED') // çµæ„Ÿç”¨æ·¡æ©™è‰²èƒŒæ™¯
            .borderRadius(16)
          }
          .swipeAction({ end: this.DeleteAction(item.id, 'event_id') }) // ä¼ IDå¤„ç†åˆ é™¤
        })
      }
      .width('100%').padding({ left: 16, right: 16, bottom: 100 }).layoutWeight(1)
    }
    .height('100%')
  }

  @Builder DeleteAction(key: number, type: 'student' | 'event_id') {
    Button('åˆ é™¤')
      .type(ButtonType.Normal)
      .backgroundColor('#EF4444')
      .fontColor(Color.White)
      .width(80)
      .height('100%')
      .onClick(() => {
        animateTo({ duration: 300 }, () => {
          if (type === 'student') {
            this.students.splice(key, 1);
          } else {
            // key here is actually ID for events if filtered
            if (type === 'event_id') {
              this.events = this.events.filter(e => e.id !== key);
            }
          }
        })
      })
  }

  // --- è¯¦æƒ…é¡µ BottomSheet (å¤åˆ»å›¾2) ---
  @Builder SheetContent() {
    Column() {
      // 1. é¡¶éƒ¨ï¼šæ—¥æœŸ + å…³é—­æŒ‰é’®
      Row() {
        Text(`${this.selectedDate.getMonth() + 1}æœˆ${this.selectedDate.getDate()}æ—¥`)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#111827')

        // å…³é—­æŒ‰é’®
        Button('âœ•')
          .type(ButtonType.Circle)
          .backgroundColor('#F3F4F6')
          .fontColor('#6B7280')
          .width(32)
          .height(32)
          .fontSize(14)
          .onClick(() => this.isSheetShown = false)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 24 })

      // 2. åŒæ“ä½œæŒ‰é’® (æ’è¯¾ + çµæ„Ÿ)
      Row({ space: 12 }) {
        Button() {
          Row() {
            // å›¾æ ‡å¯ä»¥ç”¨ Text æ¨¡æ‹Ÿ
            Text('ğŸ‘¤').fontSize(16).margin({ right: 8 })
            Text('æ’ä¸€èŠ‚è¯¾').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#2563EB')
          }
        }
        .backgroundColor('#EFF6FF')
        .type(ButtonType.Normal)
        .borderRadius(16)
        .layoutWeight(1)
        .height(56)
        .onClick(() => { this.isSheetShown = false; this.openDialog('class'); })

        Button() {
          Row() {
            Text('ğŸ’¡').fontSize(16).margin({ right: 8 })
            Text('è®°ä¸ªçµæ„Ÿ').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#EA580C')
          }
        }
        .backgroundColor('#FFF7ED')
        .type(ButtonType.Normal)
        .borderRadius(16)
        .layoutWeight(1)
        .height(56)
        .onClick(() => { this.isSheetShown = false; this.openDialog('inspiration'); })
      }
      .margin({ bottom: 32 })

      // 3. æ—¥ç¨‹/çµæ„Ÿåˆ—è¡¨ (Timelineæ ·å¼)
      List() {
        ForEach(this.getEventsForDay(this.selectedDate), (ev: CalendarEvent) => {
          ListItem() {
            Row() {
              // æ—¶é—´è½´å·¦ä¾§è£…é¥°
              Column() {
                // åœ†ç¯
                Circle({ width: 10, height: 10 })
                  .fill(Color.White)
                  .stroke(ev.type === 'class' ? (ev.status === 'completed' ? '#10B981' : '#3B82F6') : '#F97316')
                  .strokeWidth(2.5)
                // ç«–çº¿
                Line()
                  .width(1)
                  .height('100%') // æ’‘æ»¡é«˜åº¦
                  .backgroundColor('#E5E7EB')
                  .margin({ top: 4 })
              }
              .width(20)
              .alignItems(HorizontalAlign.Center)
              .margin({ right: 12 })

              // å†…å®¹åŒº
              Column() {
                Text(ev.time || 'å…¨å¤©')
                  .fontSize(12)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#9CA3AF')
                  .margin({ bottom: 4 })

                Row() {
                  Text(ev.type === 'class'
                    ? `${this.students.find(s => s.id === ev.studentId)?.name || 'æœªçŸ¥å­¦ç”Ÿ'} Â· è¯¾ç¨‹`
                    : 'ğŸ’¡ çµæ„Ÿç¬”è®°')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1F2937')
                    .layoutWeight(1)

                  // åˆ é™¤æŒ‰é’® (åƒåœ¾æ¡¶)
                  Text('ğŸ—‘')
                    .fontColor('#D1D5DB')
                    .fontSize(16)
                    .onClick(() => {
                      this.events = this.events.filter(e => e.id !== ev.id);
                    })
                }
                .width('100%')

                // çµæ„Ÿå†…å®¹ / è¯¾ç¨‹çŠ¶æ€
                if (ev.type === 'inspiration') {
                  Text(ev.content)
                    .fontSize(14)
                    .fontColor('#4B5563')
                    .margin({ top: 4 })
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                } else {
                  Text(ev.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…ä¸Šè¯¾')
                    .fontSize(12)
                    .fontColor(ev.status === 'completed' ? '#10B981' : '#F59E0B')
                    .margin({ top: 4 })
                }

                // åŠŸèƒ½æŒ‰é’® (å¦‚å®å†µçª—)
                if (ev.type === 'class' && ev.status !== 'completed') {
                  Row({ space: 12 }) {
                    Button('ğŸ”” æé†’')
                      .height(28)
                      .fontSize(12)
                      .backgroundColor('#3B82F6')
                      .onClick(() => {
                        const studentName = this.students.find(s => s.id === ev.studentId)?.name || 'å­¦ç”Ÿ';
                        NotificationService.startClassReminder(studentName, ev.time);
                      })
                    Button('å®Œæˆ')
                      .height(28)
                      .fontSize(12)
                      .backgroundColor('#10B981')
                      .onClick(() => {
                        ev.status = 'completed';
                        const student = this.students.find(s => s.id === ev.studentId);
                        if (student) student.remainingHours -= 1;
                      })
                  }
                  .margin({ top: 12 })
                }
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              .padding({ bottom: 24 }) // æ¯ä¸ªItemåº•éƒ¨çš„é—´è·
            }
            .alignItems(VerticalAlign.Top)
            .width('100%')
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .padding(24)
    .height('60%') // åŠå±é«˜åº¦
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Tabs({ controller: this.tabsController, barPosition: BarPosition.End }) {
        TabContent() { this.CalendarView() }
        TabContent() { this.InspirationsView() }
        TabContent() { this.StudentsView() }
      }
      .barHeight(0)
      .scrollable(false)
      .backgroundColor(Color.White)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        this.CustomTabItem(0, 'æ—¥å†', 'ğŸ“…')
        this.CustomTabItem(1, 'çµæ„Ÿ', 'ğŸ’¡')
        Column().layoutWeight(1).height('100%') // ä¸­é—´å ä½
        this.CustomTabItem(2, 'å­¦ç”Ÿ', 'ğŸ‘¥')
        Column().layoutWeight(1).height('100%') // è§†è§‰å¹³è¡¡å ä½
      }
      .width('100%')
      .height(60)
      .backgroundColor(Color.White)
      .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: -5 })

      // FAB
      Button('+')
        .width(56)
        .height(56)
        .fontSize(32)
        .fontWeight(FontWeight.Lighter) // ä¿®å¤ï¼šä½¿ç”¨ Lighter æ›¿ä»£ Light
        .backgroundColor('#2563EB')
        .position({ x: '50%', y: '100%' })
        .markAnchor({ x: '50%', y: 80 })
        .shadow({ radius: 10, color: 'rgba(37, 99, 235, 0.4)', offsetY: 5 })
        .onClick(() => { this.selectedDate = new Date(); this.openDialog('class'); })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .bindSheet($$this.isSheetShown, this.SheetContent(), {
      height: SheetSize.MEDIUM,
      dragBar: false, // éšè—é»˜è®¤æ‹–æ¡ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„å¸ƒå±€
      backgroundColor: Color.White
    })
  }

  @Builder CustomTabItem(index: number, name: string, icon: string) {
    Column() {
      Text(icon).fontSize(20).margin({ bottom: 4 }).opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(name)
        .fontColor(this.currentTabIndex === index ? '#111827' : '#9CA3AF')
        .fontSize(10)
        .fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
    }
    .justifyContent(FlexAlign.Center)
    .height('100%')
    .layoutWeight(1)
    .onClick(() => {
      this.currentTabIndex = index;
      this.tabsController.changeIndex(index);
    })
  }
}
