import { dbHelper, Student, CourseRecord, InspirationRecord, TodoRecord, GroupStat, PeriodStats, CreditStats } from '../db/DBHelper';
import { common, ConfigurationConstant, Configuration } from '@kit.AbilityKit';
import { promptAction, curves, window } from '@kit.ArkUI';
import { Theme, ThemeConfig } from './AppTheme';
// ÂºïÂÖ•ÂÖ∂‰ªñÈ°µÈù¢ÁªÑ‰ª∂
import { StudentPage } from './StudentPage';
import { TodoPage } from './TodoPage';

// =======================
// 0. Âü∫Á°ÄÁ±ªÂûã‰∏éÊé•Âè£
// =======================
interface StudentGroup { name: string; studentIds: number[]; }
interface DisplayGroup { type: 'group'; date: number; records: CourseRecord[]; }
interface KnowledgeSummary { type: 'knowledge'; date: number; records: InspirationRecord[]; }
interface KnowledgePointItem { id: number; content: string; }
interface GroupedKnowledge { chapter: string; points: InspirationRecord[]; }
interface ChapterStatGroup { chapterName: string; items: GroupStat[]; }
interface TodoSummary { type: 'todo'; date: number; records: TodoRecord[]; }
type ScheduleItem = DisplayGroup | KnowledgeSummary | TodoSummary;

// =======================
// [ÁªÑ‰ª∂] ‰∏ªÈ¢òÂàáÊç¢ÂºπÁ™ó
// =======================
@CustomDialog
struct ThemeSelectDialog {
  controller: CustomDialogController
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';
  @StorageLink('isDarkMode') isDarkMode: boolean = false;

  themes: string[] = ['orange', 'blue', 'green', 'purple', 'beach', 'ocean'];
  themeNames: Record<string, string> = { 'orange': 'Ê¥ªÂäõÊ©ô', 'blue': 'ÁßëÊäÄËìù', 'green': 'Ê£Æ‰πãÁªø', 'purple': 'Ê¢¶ÂπªÁ¥´', 'beach': 'Êµ∑Â≤õÂÅáÊó•', 'ocean': 'Ê∑±Êµ∑Ëø∑Ëà™' };

  build() {
    Column() {
      Text('‰∏™ÊÄßÂåñ‰∏ªÈ¢ò').fontSize(18).fontWeight(FontWeight.Bold)
        .fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
        .margin({ bottom: 25, top: 5 }).width('100%').textAlign(TextAlign.Center)

      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
        ForEach(this.themes, (key: string) => {
          Column() {
            Button({ type: ButtonType.Circle }) {
              Stack({ alignContent: Alignment.Center }) {
                Circle({ width: 56, height: 56 })
                  .fill(Theme.getStyle(key).accent as ResourceColor)

                if (this.themeName === key) {
                  SymbolGlyph($r('sys.symbol.checkmark')).fontSize(28).fontColor([Color.White])
                }
              }
            }
            .width(56).height(56)
            .backgroundColor(Color.Transparent)
            .shadow({ radius: 8, color: key === this.themeName ? (Theme.getStyle(key).accent as string) + '60' : Color.Transparent, offsetY: 4 })
            .onClick(() => {
              animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
                this.themeName = key;
              })
            })

            Text(this.themeNames[key])
              .fontSize(12)
              .fontWeight(this.themeName === key ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.themeName === key ? (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) : (this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary))
              .margin({ top: 10 })
          }
          .width('30%').margin({ bottom: 15 })
        })
      }
      .width('100%').padding({ left: 5, right: 5, bottom: 10 })

      Button('ÂÆåÊàê').width('100%').height(45).margin({ top: 10 })
        .backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor)
        .onClick(() => { this.controller.close() })
    }
    .padding(25)
    .backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card)
    .borderRadius(24)
  }
}

// =======================
// 1. Â§çÁî®ÁªÑ‰ª∂
// =======================
@Component
struct DataCard {
  @Prop title: string = ''; @Prop value: string = ''; @Prop subText: string = '';
  icon: Resource = $r('sys.symbol.circle'); color1: string = '#007DFF'; color2: string = '#0055FF';
  build() {
    Column() {
      Row() { Text(this.title).fontSize(14).fontColor('rgba(255,255,255,0.9)'); Blank(); SymbolGlyph(this.icon).fontSize(20).fontColor([Color.White]) }.width('100%').margin({ bottom: 10 })
      Text(this.value).fontSize(28).fontWeight(FontWeight.Bold).fontColor(Color.White)
      Text(this.subText).fontSize(12).fontColor('rgba(255,255,255,0.7)').margin({ top: 4 })
    }
    .width('100%').height(110).padding(15).linearGradient({ angle: 135, colors: [[this.color1, 0.0], [this.color2, 1.0]] }).borderRadius(24).shadow({ radius: 10, color: this.color2 + '40', offsetY: 5 }).alignItems(HorizontalAlign.Start)
  }
}

@Component
struct NativeBarChart {
  @Prop @Watch('redraw') data: ChapterStatGroup[]; @Prop totalStudents: number; @State renderTrigger: number = 0; redraw() { this.renderTrigger++; }
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  build() {
    Column() {
      if (this.data.length === 0) { Column() { Text('ÊöÇÊó†Áü•ËØÜÁÇπÊï∞ÊçÆ').fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary); Text('ËØ∑Âú®"Áü•ËØÜÁÅµÊÑü"‰∏≠Ê∑ªÂä†Á´†ËäÇ').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).margin({top:4}).opacity(0.6) }.width('100%').height(150).justifyContent(FlexAlign.Center) }
      else {
        Row() { Text('Á´†ËäÇ').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('15%').textAlign(TextAlign.Center); Text('Áü•ËØÜÁÇπ').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('25%').padding({ left: 5 }); Text('ÊéåÊè°ËøõÂ∫¶').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).layoutWeight(1).padding({ left: 10 }); Text('‰∫∫Êï∞').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width(40).textAlign(TextAlign.End) }.width('100%').margin({ bottom: 15 })
        Column({ space: 0 }) {
          ForEach(this.data, (group: ChapterStatGroup) => {
            Row() {
              Column({ space: 2 }) { ForEach(group.chapterName.split(''), (char: string) => { Text(char).fontSize(12).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).textAlign(TextAlign.Center).lineHeight(14) }) }.width('15%').padding({ right: 5, top: 10, bottom: 10 }).justifyContent(FlexAlign.Center).border({ width: { right: 1 }, color: this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider })
              Column({ space: 12 }) {
                ForEach(group.items, (item: GroupStat) => {
                  Row() {
                    Text(item.name).fontSize(13).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).width('32%').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                    Stack({ alignContent: Alignment.Start }) { Row().width('100%').height(8).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).borderRadius(4); Row().width(`${item.count > 0 ? Math.max((item.count / (this.totalStudents || 1)) * 100, 5) : 0}%`).height(8).backgroundColor(item.count === this.totalStudents && item.count > 0 ? '#00AA00' : Theme.getStyle(this.themeName).accent as ResourceColor).borderRadius(4) }.layoutWeight(1).padding({ left: 10, right: 10 })
                    Text(`${item.count}‰∫∫`).fontSize(12).fontColor(item.count === 0 ? (this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary) : (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)).width(40).textAlign(TextAlign.End)
                  }.width('100%').alignItems(VerticalAlign.Center)
                })
              }.layoutWeight(1).padding({ left: 10, top: 10, bottom: 10 })
            }.width('100%').alignItems(VerticalAlign.Center).border({ width: { bottom: 1 }, color: this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider })
          })
        }
      }
    }.width('100%').padding(20).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(16).shadow({ radius: 10, color: this.isDarkMode ? Theme.colors.dark.shadow : Theme.colors.light.shadow, offsetY: 2 })
  }
}

// =======================
// 2. ÂºπÁ™óÁªÑ‰ª∂ÂÆö‰πâ
// =======================

@CustomDialog
struct ReportCenterDialog {
  controller: CustomDialogController; @State weekFinished: number = 0; @State monthFinished: number = 0; @State studentCount: number = 0; @State creditStats: CreditStats = { used: 0, total: 0 }; @State groupedStats: ChapterStatGroup[] = [];
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  async aboutToAppear() { await this.fetchAllData(); }
  async fetchAllData() { const pStats = await dbHelper.getPeriodStats(); this.weekFinished = pStats.week; this.monthFinished = pStats.month; this.creditStats = await dbHelper.getTotalCreditStats(); const students = await dbHelper.getStudents(); this.studentCount = students.length; await this.processKnowledgeData(); }
  async processKnowledgeData() { const start = 0; const end = new Date().getTime() + 31536000000; const allInspirations = await dbHelper.getInspirationsByDate(start, end); const rawStats = await dbHelper.getKnowledgeStats(); const statsMap = new Map<string, number>(); rawStats.forEach(s => statsMap.set(s.name, s.count)); const structureMap = new Map<string, Set<string>>(); allInspirations.forEach(insp => { const ch = insp.chapter || "Êú™ÂàÜÁ±ª"; const pt = insp.point || "Êú™Áü•"; if (!structureMap.has(ch)) structureMap.set(ch, new Set()); structureMap.get(ch)?.add(pt); }); const result: ChapterStatGroup[] = []; structureMap.forEach((pointSet, chapterName) => { const items: GroupStat[] = []; pointSet.forEach(pointName => items.push({ name: pointName, count: statsMap.get(pointName) || 0, studentNames: [] })); if (items.length > 0) result.push({ chapterName, items }); }); this.groupedStats = result.sort((a, b) => a.chapterName.localeCompare(b.chapterName)); }
  build() {
    Column() {
      Row() { Text('Êï∞ÊçÆÁªüËÆ°').fontSize(24).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').padding({ top: 10, bottom: 5 }).justifyContent(FlexAlign.Center).margin({ bottom: 25 })
      Scroll() {
        Column({ space: 20 }) {
          Column() {
            Row() { SymbolGlyph($r('sys.symbol.clock')).fontSize(20).fontColor([Theme.getStyle('orange').accent]).margin({ right: 8 }); Text('ËØæÊó∂ÁªüËÆ°').fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').margin({ bottom: 12 })
            Grid() {
              GridItem() { DataCard({ title: 'Êú¨Âë®Ê∂àËØæ', value: this.weekFinished.toString(), subText: 'ËäÇËØæÁ®ã', icon: $r('sys.symbol.calendar'), color1: '#007DFF', color2: '#0055FF' }) }
              GridItem() { DataCard({ title: 'Êú¨ÊúàÊ∂àËØæ', value: this.monthFinished.toString(), subText: 'ËäÇËØæÁ®ã', icon: $r('sys.symbol.text_aligncenter'), color1: '#FF9900', color2: '#FF7700' }) }
              GridItem() { DataCard({ title: 'ÊÄªÂ≠¶Âëò', value: this.studentCount.toString(), subText: '‰∫∫', icon: $r('sys.symbol.person_2_fill'), color1: '#00CC88', color2: '#00AA66' }) }
              GridItem() { DataCard({ title: 'Ââ©‰ΩôÊÄªËØæÊó∂', value: (this.creditStats.total - this.creditStats.used).toString(), subText: 'ËØæÊó∂', icon: $r('sys.symbol.clock_fill'), color1: '#9900FF', color2: '#7700DD' }) }
            }.columnsTemplate('1fr 1fr').columnsGap(12).rowsGap(12).height(240)
          }.width('100%')
          Column() {
            Row() { SymbolGlyph($r('sys.symbol.star_fill')).fontSize(20).fontColor(['#FFD700']).margin({ right: 8 }); Text('Áü•ËØÜÁÇπÊéåÊè°ÂàÜÂ∏É').fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').margin({ bottom: 15 })
            NativeBarChart({ data: this.groupedStats, totalStudents: this.studentCount })
          }.width('100%')
          Column().height(30)
        }.width('100%').justifyContent(FlexAlign.Start)
      }.layoutWeight(1).align(Alignment.Top).scrollBar(BarState.Off)
    }.width('100%').height('85%').padding(20).backgroundColor(this.isDarkMode ? '#1A1A1A' : '#F7F8FA').borderRadius({ topLeft: 24, topRight: 24 }).justifyContent(FlexAlign.Start)
  }
}

@CustomDialog
struct RescheduleDialog {
  controller: CustomDialogController; courseId: number = 0; originalDate: number = 0; onConfirm: () => void = () => {}
  @State selectedDate: Date = new Date(); aboutToAppear() { this.selectedDate = new Date(this.originalDate); }
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  build() {
    Column() {
      Text('ËØæÁ®ãË∞ÉÊï¥').fontSize(18).fontWeight(FontWeight.Bold).margin({ bottom: 20 }).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
      DatePicker({ start: new Date(), selected: this.selectedDate }).onChange((v: DatePickerResult) => { if(v.year&&v.month&&v.day) this.selectedDate.setFullYear(v.year,v.month,v.day) })
      TimePicker({ selected: this.selectedDate }).onChange((v: TimePickerResult) => { if(v.hour!==undefined&&v.minute!==undefined) this.selectedDate.setHours(v.hour,v.minute) })
      Row({ space: 20 }) { Button('ÂèñÊ∂à').layoutWeight(1).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).onClick(() => this.controller.close());
        Button('Á°ÆËÆ§').layoutWeight(1).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(async () => { await dbHelper.rescheduleCourse(this.courseId, this.selectedDate.getTime()); this.onConfirm(); this.controller.close(); }) }.width('100%').margin({ top: 20 })
    }.padding(20).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(20)
  }
}

@CustomDialog
struct AddTodoDialog {
  controller: CustomDialogController; confirm: (content: string) => void = () => {}; @State content: string = ''
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  build() {
    Column({ space: 20 }) {
      Text('Êñ∞Âª∫ÂæÖÂäû').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 }).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
      TextInput({ placeholder: 'ÂÜÖÂÆπ', text: this.content }).onChange((v: string) => this.content = v).backgroundColor(this.isDarkMode ? Theme.colors.dark.inputBg : Theme.colors.light.inputBg).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).placeholderColor(this.isDarkMode ? Theme.colors.dark.placeholder : Theme.colors.light.placeholder).height(50).borderRadius(8)
      Row({ space: 20 }) { Button('ÂèñÊ∂à').layoutWeight(1).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).onClick(() => { this.controller.close() });
        Button('‰øùÂ≠ò').layoutWeight(1).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(() => { if (this.content) this.confirm(this.content); }) }.width('100%')
    }.padding(25).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(16)
  }
}

@CustomDialog
struct DailyDetailDialog {
  controller: CustomDialogController; currentDate: Date = new Date(); onDataChanged: () => void = () => {}; onOpenAnalysis: (group: DisplayGroup) => void = () => {}; onAddCourse: () => void = () => {};
  @State items: ScheduleItem[] = []; @State selectedPointId: number = -1; rescheduleController: CustomDialogController | null = null;
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  async aboutToAppear() { await this.refreshLocalData(); }
  async refreshLocalData() {
    const s = new Date(this.currentDate); s.setHours(0,0,0,0); const e = new Date(this.currentDate); e.setHours(23,59,59,999);
    const c = await dbHelper.getCoursesByDate(s.getTime(), e.getTime());
    const i = await dbHelper.getInspirationsByDate(s.getTime(), e.getTime());
    const t = await dbHelper.getTodosByDate(s.getTime(), e.getTime());
    const map = new Map<number, CourseRecord[]>(); c.forEach(r => { if(!map.has(r.date)) map.set(r.date, []); map.get(r.date)?.push(r); });
    const groups: DisplayGroup[] = []; map.forEach((recs, date) => groups.push({ type: 'group', date, records: recs }));
    const finalItems: ScheduleItem[] = [...groups];
    if (i.length > 0) finalItems.push({ type: 'knowledge', date: s.getTime(), records: i } as KnowledgeSummary);
    if (t.length > 0) finalItems.push({ type: 'todo', date: s.getTime(), records: t } as TodoSummary);
    this.items = finalItems.sort((a, b) => a.date - b.date); this.onDataChanged();
  }
  groupInspirations(records: InspirationRecord[]): GroupedKnowledge[] { const map = new Map<string, InspirationRecord[]>(); records.forEach(r => { const ch = r.chapter || 'Êú™ÂàÜÁ±ª'; if (!map.has(ch)) map.set(ch, []); map.get(ch)?.push(r); }); const result: GroupedKnowledge[] = []; map.forEach((points, chapter) => result.push({ chapter, points })); return result.sort((a, b) => a.chapter.localeCompare(b.chapter)); }
  showActionMenu(r: CourseRecord) { ActionSheet.show({ title: `${r.studentName} ÁöÑËØæÁ®ã`, message: 'ËØ∑ÈÄâÊã©Êìç‰Ωú', autoCancel: true, alignment: DialogAlignment.Bottom, confirm: { value: 'ÂèñÊ∂à', action: () => {} }, sheets: [ { title: 'üóìÔ∏è Ë∞ÉËØæ', action: () => { this.rescheduleController = new CustomDialogController({ builder: RescheduleDialog({ courseId: r.id, originalDate: r.date, onConfirm: () => { this.refreshLocalData(); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); } }), alignment: DialogAlignment.Bottom }); this.rescheduleController.open(); } }, { title: 'üèñÔ∏è ËØ∑ÂÅá', action: async () => { await dbHelper.markAsLeave(r.id); this.refreshLocalData(); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); } }, { title: '‚ùå Âà†Èô§', action: async () => { await dbHelper.deleteCourse(r.id); this.refreshLocalData(); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); } } ] }); }
  async finishGroup(group: DisplayGroup) { for (const r of group.records) { if (r.isFinished === 0 && r.status === 0) await dbHelper.finishCourse(r.id, r.studentId); } this.refreshLocalData(); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); }
  formatTime(ts: number): string { const d = new Date(ts); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
  getTitleDate(): string { return `${this.currentDate.getMonth() + 1}Êúà${this.currentDate.getDate()}Êó•`; }

  build() {
    Column() {
      Row() { Text(this.getTitleDate()).fontSize(24).fontWeight(FontWeight.Bold).margin({ right: 10 }).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); Divider().vertical(true).height(18).color(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).strokeWidth(2).margin({ right: 10 }); Text('‰ªäÊó•Ê¶ÇËßà').fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); Blank();
        Button('ÊéíËØæ').fontSize(12).height(28).backgroundColor('#33CC88').margin({ right: 10 }).onClick(() => { this.onAddCourse() });
        Button('Êî∂Ëµ∑').fontSize(12).height(28).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(() => { this.controller.close() }) }.width('100%').margin({ bottom: 20 })
      if (this.items.length === 0) { Column() { Text('ÊöÇÊó†ÂÆâÊéí').fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary) }.width('100%').height(100).justifyContent(FlexAlign.Center) }
      else {
        List({ space: 15 }) {
          ForEach(this.items, (item: ScheduleItem) => {
            ListItem() {
              if (item.type === 'group') {
                Row() { Divider().vertical(true).height(40).color(Theme.getStyle(this.themeName).accent as ResourceColor).strokeWidth(4).margin({ right: 10 }); Column() { Text('ËØæÁ®ã').fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).fontWeight(FontWeight.Bold); Text(this.formatTime(item.date)).fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).margin({top:4}) }.alignItems(HorizontalAlign.Start).width(60); Text((item as DisplayGroup).records.map(r => r.studentName).join('„ÄÅ')).fontSize(14).fontWeight(FontWeight.Medium).layoutWeight(1).textAlign(TextAlign.Center).maxLines(1).textOverflow({overflow: TextOverflow.Ellipsis}).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).onClick(() => { this.showActionMenu((item as DisplayGroup).records[0]) }); Row({ space: 8 }) { Button('ÂàÜÊûê').fontSize(10).height(24).backgroundColor(Theme.getStyle(this.themeName).accentLight as ResourceColor).fontColor(Theme.getStyle(this.themeName).accent as ResourceColor).padding({ left: 8, right: 8 }).onClick(() => { this.onOpenAnalysis(item as DisplayGroup); this.controller.close(); }); if ((item as DisplayGroup).records.some(r => r.isFinished === 0 && r.status === 0)) { Button('Ê∂àËØæ').fontSize(10).height(24).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).padding({ left: 8, right: 8 }).onClick(() => { this.finishGroup(item as DisplayGroup) }) } else { Text('Â∑≤Ê∂àËØæ').fontSize(10).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).padding(4).borderRadius(4) } }.margin({ left: 5 }) }
                .padding({ left: 10, right: 10, top: 12, bottom: 12 }).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(12).shadow({ radius: 8, color: this.isDarkMode ? Theme.colors.dark.shadow : 'rgba(0,0,0,0.08)', offsetY: 3 }).border({ width: 1, color: this.isDarkMode ? 'transparent' : 'rgba(0,0,0,0.05)' }).margin({ left: 5, right: 5 })
              } else if (item.type === 'knowledge') {
                Column() {
                  Row() { SymbolGlyph($r('sys.symbol.lightbulb')).fontSize(20).fontColor(['#FF9900']).margin({right:8}); Text('‰ªäÊó•Áü•ËØÜÁÇπ').fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').margin({bottom:10})
                  ForEach(this.groupInspirations((item as KnowledgeSummary).records), (group: GroupedKnowledge) => {
                    Column() {
                      Text(group.chapter).fontSize(12).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).margin({ bottom: 4, top: 8 }).width('100%')
                      Flex({ wrap: FlexWrap.Wrap }) {
                        ForEach(group.points, (r: InspirationRecord) => {
                          Stack({ alignContent: Alignment.TopEnd }) {
                            Text(r.point).fontSize(13).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).borderRadius(16).margin({ top: 6, right: 6, bottom: 6 }).onClick(() => { this.selectedPointId = (this.selectedPointId === r.id) ? -1 : r.id; })
                            if (this.selectedPointId === r.id) { Button({ type: ButtonType.Circle }) { SymbolGlyph($r('sys.symbol.xmark')).fontSize(10).fontColor([Color.White]).fontWeight(FontWeight.Bold) }.width(16).height(16).backgroundColor('#FF4444').offset({ x: 2, y: -2 }).onClick(async () => { await dbHelper.deleteInspiration(r.id); this.refreshLocalData(); this.selectedPointId = -1; }).shadow({ radius: 2, color: 'rgba(0,0,0,0.3)', offsetY: 1 }).zIndex(10) }
                          }.margin({ right: 8, bottom: 4 })
                        })
                      }
                    }.alignItems(HorizontalAlign.Start).width('100%').margin({ bottom: 2 })
                  })
                }.width('calc(100% - 10vp)').padding(15).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(12).shadow({ radius: 8, color: this.isDarkMode ? Theme.colors.dark.shadow : 'rgba(0,0,0,0.08)', offsetY: 3 }).border({ width: 1, color: this.isDarkMode ? 'transparent' : 'rgba(0,0,0,0.05)' }).margin({ left: 5, right: 5 })
              } else if (item.type === 'todo') {
                Column() {
                  Row() { SymbolGlyph($r('sys.symbol.list_bullet')).fontSize(20).fontColor(['#FF9900']).margin({right:8}); Text('‰ªäÊó•ÂæÖÂäû').fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').margin({bottom:10})
                  List({ space: 8 }) {
                    ForEach((item as TodoSummary).records, (t: TodoRecord) => {
                      ListItem() {
                        Row() {
                          Stack({ alignContent: Alignment.Center }) { Circle({ width: 18, height: 18 }).fill(t.isFinished ? '#FF9900' : 'transparent').stroke('#FF9900').strokeWidth(1.5); if (t.isFinished) SymbolGlyph($r('sys.symbol.checkmark')).fontSize(11).fontColor([Color.White]) }.width(24).height(24).onClick(async () => { await dbHelper.updateTodoStatus(t.id, t.isFinished ? 0 : 1); this.refreshLocalData(); }).margin({ right: 10 })
                          Text(t.content).fontSize(14).fontColor(t.isFinished ? (this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary) : (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)).decoration({ type: t.isFinished ? TextDecorationType.LineThrough : TextDecorationType.None, color: this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary }).layoutWeight(1)
                        }.width('100%')
                      }
                    })
                  }
                }.width('calc(100% - 10vp)').padding(15).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(12).shadow({ radius: 8, color: this.isDarkMode ? Theme.colors.dark.shadow : 'rgba(0,0,0,0.08)', offsetY: 3 }).border({ width: 1, color: this.isDarkMode ? 'transparent' : 'rgba(0,0,0,0.05)' }).margin({ left: 5, right: 5 })
              }
            }
          })
        }.width('100%').height(400).scrollBar(BarState.Off)
      }
    }.width('100%').padding(20).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius({ topLeft: 24, topRight: 24 })
  }
}

// =======================
// 2.5 ÂæÖÂäûËØ¶ÊÉÖÂºπÁ™ó
// =======================
@CustomDialog
struct TodoDetailDialog {
  controller: CustomDialogController; currentDate: Date = new Date(); onDataChanged: () => void = () => {};
  @State todos: TodoRecord[] = []; @State unFinishedList: TodoRecord[] = []; @State finishedList: TodoRecord[] = [];
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  // „ÄêÊñ∞Â¢û„ÄëÁõëÂê¨‰∏ªÈ¢ò
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';
  addTodoCtrl: CustomDialogController | null = null;
  async aboutToAppear() { await this.refreshLocalData(); }
  async refreshLocalData() { const s = new Date(this.currentDate); s.setHours(0,0,0,0); const e = new Date(this.currentDate); e.setHours(23,59,59,999); const all = await dbHelper.getTodosByDate(s.getTime(), e.getTime()); animateTo({ duration: 400, curve: Curve.FastOutSlowIn }, () => { this.todos = all; this.unFinishedList = all.filter(t => t.isFinished === 0); this.finishedList = all.filter(t => t.isFinished === 1); this.onDataChanged(); }); }
  openAddTodo() { this.addTodoCtrl = new CustomDialogController({ builder: AddTodoDialog({ confirm: async (c) => { await dbHelper.addTodo(this.currentDate.getTime(), c); this.refreshLocalData(); if(this.addTodoCtrl) this.addTodoCtrl.close(); } }), alignment: DialogAlignment.Bottom }); this.addTodoCtrl.open(); }
  async toggleFinish(t: TodoRecord) { await dbHelper.updateTodoStatus(t.id, t.isFinished === 1 ? 0 : 1); this.refreshLocalData(); }
  async handleDelete(id: number) { await dbHelper.deleteTodo(id); this.refreshLocalData(); }
  @Builder SwipeMenu(id: number) { Row() { Button({ type: ButtonType.Circle }) { SymbolGlyph($r('sys.symbol.trash')).fontSize(24).fontColor([Color.White]) }.width(60).height(60).backgroundColor(Color.Red).onClick(() => { this.handleDelete(id) }) }.width(80).justifyContent(FlexAlign.Center) }
  @Builder GroupHeader(title: string) { Text(title).fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('100%').padding({ top: 12, bottom: 8 }) }
  @Builder TodoItem(t: TodoRecord) {
    ListItem() {
      Row() {
        Stack() { Circle({ width: 24, height: 24 }).fill(t.isFinished ? Theme.getStyle(this.themeName).accent as ResourceColor : 'transparent').stroke(Theme.getStyle(this.themeName).accent as ResourceColor).strokeWidth(2); if (t.isFinished) SymbolGlyph($r('sys.symbol.checkmark')).fontSize(14).fontColor([Color.White]) }.onClick(() => { this.toggleFinish(t) }).margin({ right: 15 })
        Text(t.content).fontSize(16).fontColor(t.isFinished ? (this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary) : (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)).decoration({ type: t.isFinished ? TextDecorationType.LineThrough : TextDecorationType.None, color: this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary }).layoutWeight(1)
      }.width('100%').padding(15).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).borderRadius(12)
    }.swipeAction({ end: () => { this.SwipeMenu(t.id) } })
  }
  build() {
    Column() {
      Row() { Column() { Text('ÂæÖÂäû‰∫ãÈ°π').fontSize(24).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); Text(`Â∑≤ÂÆåÊàê ${this.finishedList.length}/${this.todos.length}`).fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).margin({top:2}) }.alignItems(HorizontalAlign.Start); Blank();
        Button('Êñ∞Âª∫').height(36).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(() => { this.openAddTodo() }) }.width('100%').margin({ bottom: 10 })
      if (this.todos.length === 0) { Column() { Text('‰ªäÂ§©Ê≤°ÊúâÂæÖÂäû‰ªªÂä°').fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary) }.width('100%').height(200).justifyContent(FlexAlign.Center) }
      else {
        List({ space: 10 }) {
          if (this.unFinishedList.length > 0) { ListItem() { this.GroupHeader('ËøõË°å‰∏≠') }; ForEach(this.unFinishedList, (t: TodoRecord) => { this.TodoItem(t) }, (t: TodoRecord) => t.id.toString()) }
          if (this.finishedList.length > 0) { ListItem() { this.GroupHeader('Â∑≤ÂÆåÊàê') }; ForEach(this.finishedList, (t: TodoRecord) => { this.TodoItem(t) }, (t: TodoRecord) => t.id.toString()) }
        }.width('100%').height(350).scrollBar(BarState.Off)
      }
    }.padding(20).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius({ topLeft: 20, topRight: 20 })
  }
}

// =======================
// 2.6 ËØæÂêéÂàÜÊûê Sheet
// =======================
@Component
struct PostClassAnalysisSheet {
  @Prop courseDate: number; @Prop records: CourseRecord[]; onClose: () => void = () => {}; @State knowledgePoints: string[] = []; @State students: Student[] = []; @State masteryMatrix: boolean[][] = []
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  // „ÄêÊñ∞Â¢û„ÄëÁõëÂê¨‰∏ªÈ¢ò
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  async aboutToAppear() {
    const start = new Date(this.courseDate); start.setHours(0,0,0,0); const end = new Date(this.courseDate); end.setHours(23,59,59,999);
    const inspirations = await dbHelper.getInspirationsByDate(start.getTime(), end.getTime());
    const pointsSet = new Set<string>(); inspirations.forEach(ins => { if (ins.point) pointsSet.add(ins.point); }); this.knowledgePoints = Array.from(pointsSet);
    if (this.records.length > 0) { const allStudents = await dbHelper.getStudents(); const targetIds = this.records.map(r => r.studentId); this.students = allStudents.filter(s => targetIds.includes(s.id)); }
    if (this.students.length > 0 && this.knowledgePoints.length > 0) {
      const matrix: boolean[][] = []; for (let i = 0; i < this.students.length; i++) { const row: boolean[] = []; const masteredPoints = await dbHelper.getStudentMastery(this.students[i].id, start.getTime()); for (let j = 0; j < this.knowledgePoints.length; j++) row.push(masteredPoints.includes(this.knowledgePoints[j])); matrix.push(row); } this.masteryMatrix = matrix;
    }
  }
  build() {
    Column() {
      Row().width(40).height(5).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).borderRadius(2.5).margin({ top: 10, bottom: 20 })
      Row() { Column() { Text('ËØæÂêéÂàÜÊûê').fontSize(22).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); Text('Ê†áËÆ∞Â≠¶Âëò‰ªäÊó•ÊéåÊè°ÁöÑÁü•ËØÜÁÇπ').fontSize(12).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).margin({ top: 4 }) }.alignItems(HorizontalAlign.Start); Blank();
        Button('ÂÆåÊàê').height(32).fontSize(14).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(() => { this.onClose() }) }.width('100%').margin({ bottom: 20 })
      if (this.knowledgePoints.length === 0) { Column() { SymbolGlyph($r('sys.symbol.questionmark_circle')).fontSize(40).fontColor(['#DDDDDD']).margin({ bottom: 10 }); Text('‰ªäÊó•Êú™Ê∑ªÂä†Áü•ËØÜÁÅµÊÑü').fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).fontSize(14) }.height(200).justifyContent(FlexAlign.Center).width('100%') }
      else {
        List() {
          ForEach(this.students, (stu: Student, i: number) => {
            ListItem() {
              Column() {
                Row() { Text(stu.name.substring(0, 1)).fontSize(14).fontWeight(FontWeight.Bold).fontColor(Color.White).width(28).height(28).textAlign(TextAlign.Center).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).borderRadius(14).margin({ right: 10 }); Text(stu.name).fontSize(16).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary) }.width('100%').margin({ bottom: 12 })
                Divider().color(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).margin({ bottom: 12 })
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.knowledgePoints, (p: string, j: number) => {
                    Row() { if (this.masteryMatrix[i] && this.masteryMatrix[i][j]) SymbolGlyph($r('sys.symbol.checkmark')).fontSize(12).fontColor([Color.White]).margin({ right: 4 }); Text(p).fontSize(12).fontColor((this.masteryMatrix[i] && this.masteryMatrix[i][j]) ? Color.White : '#666') }
                    .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor((this.masteryMatrix[i] && this.masteryMatrix[i][j]) ? Theme.getStyle(this.themeName).accent as ResourceColor : (this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider)).borderRadius(16).margin({ right: 8, bottom: 8 }).onClick(async () => { const newRow = [...this.masteryMatrix[i]]; newRow[j] = !newRow[j]; this.masteryMatrix[i] = newRow; this.masteryMatrix = [...this.masteryMatrix]; const start = new Date(this.courseDate); start.setHours(0,0,0,0); await dbHelper.updateMastery(this.students[i].id, start.getTime(), this.knowledgePoints[j], newRow[j]); })
                  })
                }
              }.width('100%').padding(15).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(16).shadow({ radius: 8, color: '#0A000000', offsetY: 2 }).margin({ bottom: 15 })
            }
          })
        }.width('100%').layoutWeight(1).scrollBar(BarState.Off)
      }
    }.width('100%').height('100%').padding({ left: 20, right: 20, bottom: 20 })
  }
}

// =======================
// 2.7 Áü•ËØÜ/ËØæÁ®ãÊ∑ªÂä†ÂºπÁ™ó
// =======================
@CustomDialog
struct AddKnowledgeDialog {
  controller: CustomDialogController; confirm: (chapter: string, points: string[]) => void = () => {}; @State chapter: string = ''; @State p1: string = ''; @State p2: string = ''; @State p3: string = ''; @State p4: string = ''
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  // „ÄêÊñ∞Â¢û„Äë
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  @Builder InputField(placeholder: string, text: string, onChange: (v: string) => void) {
    TextInput({ placeholder: placeholder, text: text })
      .onChange(onChange)
      .backgroundColor(this.isDarkMode ? Theme.colors.dark.inputBg : Theme.colors.light.inputBg)
      .fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
      .placeholderColor(this.isDarkMode ? Theme.colors.dark.placeholder : Theme.colors.light.placeholder)
      .height(50)
      .borderRadius(12)
  }

  build() {
    Column({ space: 15 }) {
      Row().width(40).height(5).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).borderRadius(2.5).margin({ top: 10, bottom: 10 })
      Row() { Text('‰ªäÊó•Áü•ËØÜÁÅµÊÑü').fontSize(22).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); Blank();
        Button('‰øùÂ≠ò').height(32).backgroundColor('#FF9900').onClick(() => { const pts: string[] = [this.p1, this.p2, this.p3, this.p4].filter(p => p.trim() !== ''); if (this.chapter && pts.length > 0) { this.confirm(this.chapter, pts); this.controller.close(); } else { promptAction.showToast({ message: 'ËØ∑ÂÆåÊï¥Â°´ÂÜôÁ´†ËäÇÂíåÁü•ËØÜÁÇπ' }) } }) }.width('100%').margin({ bottom: 10 })

      this.InputField('Áü•ËØÜÁ´†ËäÇ (Â¶ÇÔºöÁ¨¨‰∏ÄÁ´† ‰πêÁêÜÂü∫Á°Ä)', this.chapter, (v) => this.chapter = v)
      this.InputField('Áü•ËØÜÁÇπ 1', this.p1, (v) => this.p1 = v)
      this.InputField('Áü•ËØÜÁÇπ 2', this.p2, (v) => this.p2 = v)
      this.InputField('Áü•ËØÜÁÇπ 3', this.p3, (v) => this.p3 = v)
      this.InputField('Áü•ËØÜÁÇπ 4', this.p4, (v) => this.p4 = v)

      Button('ÂèñÊ∂à').width('100%').height(45).backgroundColor('transparent').fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).onClick(() => this.controller.close())
    }
    .padding(20).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card)
    .width('100%').borderRadius({ topLeft: 24, topRight: 24 })
  }
}

@CustomDialog
struct AddCourseDialog {
  controller: CustomDialogController; students: Student[] = []; groups: StudentGroup[] = []; confirm: (sids: number[], h: number, m: number, note: string) => void = () => {}
  @State selectedSids: number[] = []; @State note: string = ''; @State hour: string = '10'; @State min: string = '00'; @State hours: string[] = []; @State mins: string[] = []; @State currentGroupName: string = '';
  @StorageLink('isDarkMode') isDarkMode: boolean = false;
  // „ÄêÊñ∞Â¢û„Äë
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  aboutToAppear() { for(let i=0;i<24;i++) this.hours.push(i.toString().padStart(2,'0')); for(let i=0;i<60;i++) this.mins.push(i.toString().padStart(2,'0')); }
  toggleGroup(g: StudentGroup) { if (this.currentGroupName === g.name) { this.selectedSids = []; this.currentGroupName = ''; } else { this.selectedSids = [...g.studentIds]; this.currentGroupName = g.name; } }
  toggleStudent(id: number) { if (this.selectedSids.includes(id)) { this.selectedSids = this.selectedSids.filter(s => s !== id); } else { this.selectedSids.push(id); } this.currentGroupName = ''; }
  build() {
    Column({ space: 15 }) {
      Text('ÂÆâÊéíËØæÁ®ã').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 5 }).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
      if (this.groups.length > 0) { Column({ space: 8 }) { Text('Âø´Êç∑ÂàÜÁªÑ').fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('100%'); List({ space: 10 }) { ForEach(this.groups, (g: StudentGroup) => { ListItem() { Text(g.name).fontSize(12).fontColor(this.currentGroupName === g.name ? Color.White : Theme.getStyle(this.themeName).accent as ResourceColor).padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor(this.currentGroupName === g.name ? Theme.getStyle(this.themeName).accent as ResourceColor : (this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider)).borderRadius(16).onClick(() => this.toggleGroup(g)) } }) }.listDirection(Axis.Horizontal).width('100%').height(35).scrollBar(BarState.Off) }.width('100%') }
      Text('ÈÄâÊã©Â≠¶Áîü').fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('100%')
      Grid() { ForEach(this.students, (s: Student) => { GridItem() { Text(s.name).fontSize(14).fontColor(this.selectedSids.includes(s.id) ? Color.White : (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)).textAlign(TextAlign.Center).width('100%').padding({ top: 6, bottom: 6 }).backgroundColor(this.selectedSids.includes(s.id) ? Theme.getStyle(this.themeName).accent as ResourceColor : (this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider)).borderRadius(8).onClick(() => { this.toggleStudent(s.id) }) } }) }.columnsTemplate('1fr 1fr 1fr 1fr').columnsGap(8).rowsGap(8).height(100)
      Column({ space: 5 }) { Text('‰∏äËØæÊó∂Èó¥').fontSize(14).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).width('100%'); Row() { TextPicker({ range: this.hours, selected: 10 }).onChange((v: string | string[]) => this.hour = (Array.isArray(v) ? v[0] : v)).layoutWeight(1).height(50); Text(':').fontSize(20).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary); TextPicker({ range: this.mins, selected: 0 }).onChange((v: string | string[]) => this.min = (Array.isArray(v) ? v[0] : v)).layoutWeight(1).height(50); }.width('100%') }.width('100%')
      TextInput({ placeholder: 'Â§áÊ≥®', text: this.note }).onChange((v: string) => this.note = v).backgroundColor(this.isDarkMode ? Theme.colors.dark.inputBg : Theme.colors.light.inputBg).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).placeholderColor(this.isDarkMode ? Theme.colors.dark.placeholder : Theme.colors.light.placeholder).height(45).borderRadius(8)
      Row({ space: 20 }) { Button('ÂèñÊ∂à').layoutWeight(1).backgroundColor(this.isDarkMode ? Theme.colors.dark.divider : Theme.colors.light.divider).fontColor(this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary).onClick(() => this.controller.close());
        Button('Á°ÆÂÆö').layoutWeight(1).backgroundColor(Theme.getStyle(this.themeName).accent as ResourceColor).onClick(() => { this.confirm(this.selectedSids, parseInt(this.hour), parseInt(this.min), this.note); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); }) }.width('100%')
    }.padding(25).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius({ topLeft: 24, topRight: 24 })
  }
}

// =======================
// 10. ‰∏ªÈ°µÈù¢ (CalendarView - ÁªÑ‰ª∂Âåñ)
// =======================
@Component
export struct CalendarView {
  @State currentYear: number = new Date().getFullYear();
  @State currentMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State daysInMonth: number[] = [];
  @State startWeekDay: number = 0;
  @State courseMarkers: number[] = [];
  @State inspMarkers: number[] = [];
  @State todayCoursesCount: number = 0;
  @State todayTodosCount: number = 0;
  @State gridHeight: number = 300;
  @State isShowAnalysisSheet: boolean = false;
  @State currentAnalysisRecords: CourseRecord[] = [];
  @State currentAnalysisDate: number = 0;
  @StorageProp('AppGlobalUpdate') @Watch('refreshData') updateSignal: number = 0;
  @StorageLink('GlobalShortcutAction') @Watch('onShortcutTrigger') shortcutAction: string = '';

  // 1. ÁõëÂê¨Á≥ªÁªüÈªëÂ§úÊ®°Âºè
  @StorageProp('currentColorMode') @Watch('onSystemModeChange') systemColorMode: number =
    ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT;
  @StorageLink('isDarkMode') isDarkMode: boolean = false;

  // 2. ÁõëÂê¨‰∏ªÈ¢òÈ£éÊ†º
  @StorageLink('GlobalThemeStyle') themeName: string = 'orange';

  @State currentTabIndex: number = 0;

  todoController: CustomDialogController | null = null;
  directAddCourseController: CustomDialogController | null = null;
  reportController: CustomDialogController | null = null;
  detailController: CustomDialogController | null = null;
  knowledgeController: CustomDialogController | null = null;
  themeController: CustomDialogController | null = null;

  async aboutToAppear() {
    let context = getContext(this) as common.UIAbilityContext;
    await dbHelper.initDB(context);
    Environment.envProp('currentColorMode', ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT);
    this.isDarkMode = context.config.colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;

    this.initCalendar();
    this.refreshData();
    this.onShortcutTrigger();
  }

  onSystemModeChange() {
    this.isDarkMode = (this.systemColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK);
    AppStorage.setOrCreate('isDarkMode', this.isDarkMode);
  }

  onPageShow() {
    let context = getContext(this) as common.UIAbilityContext;
    const sysMode = context.config.colorMode;
    if (sysMode !== undefined) {
      this.isDarkMode = sysMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;
    }
    this.refreshData();
    this.onShortcutTrigger();
  }

  async showAddCourseDialog(targetDate?: Date) {
    const students = await dbHelper.getStudents();
    const groups: StudentGroup[] = []; const map = new Map<string, number[]>();
    students.forEach(s => { const g = s.groupName || 'ÈªòËÆ§'; if (!map.has(g)) map.set(g, []); map.get(g)?.push(s.id); });
    if (students.length > 1) groups.push({ name: 'ÂÖ®Âëò', studentIds: students.map(s => s.id) }); map.forEach((ids, name) => { if (ids.length > 0) groups.push({ name, studentIds: ids }); });
    this.directAddCourseController = new CustomDialogController({ builder: AddCourseDialog({ students, groups, confirm: async (sids, h, m, note) => { const d = targetDate ? new Date(targetDate) : new Date(); d.setHours(h, m, 0, 0); for(const sid of sids) await dbHelper.addCourse(sid, d.getTime(), note); this.refreshData(); AppStorage.setOrCreate('AppGlobalUpdate', Date.now()); if(this.directAddCourseController) this.directAddCourseController.close(); } }), alignment: DialogAlignment.Bottom, customStyle: true });
    this.directAddCourseController.open();
  }
  async onShortcutTrigger() { if (!this.shortcutAction) return; if (this.shortcutAction === 'action_add_course') { setTimeout(() => { this.showAddCourseDialog(); AppStorage.setOrCreate('GlobalShortcutAction', ''); }, 200); } }
  openAddCourse() { this.showAddCourseDialog(); }
  openReportCenter() { this.reportController = new CustomDialogController({ builder: ReportCenterDialog(), alignment: DialogAlignment.Bottom, customStyle: true }); this.reportController.open(); }
  openAddKnowledge() { this.knowledgeController = new CustomDialogController({ builder: AddKnowledgeDialog({ confirm: async (chapter, points) => { const d = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay); for(const p of points) await dbHelper.addKnowledgeInspiration(d.getTime(), chapter, p); this.refreshData(); } }), alignment: DialogAlignment.Bottom, customStyle: true }); this.knowledgeController.open(); }

  openThemeSetting() {
    this.themeController = new CustomDialogController({ builder: ThemeSelectDialog(), alignment: DialogAlignment.Bottom, customStyle: true });
    this.themeController.open();
  }

  initCalendar() { const d = new Date(this.currentYear, this.currentMonth - 1, 1); this.startWeekDay = d.getDay(); const lastDay = new Date(this.currentYear, this.currentMonth, 0).getDate(); const rows = Math.ceil((this.startWeekDay + lastDay) / 7); this.gridHeight = rows * 60; const arr: number[] = []; for(let i=1; i<=lastDay; i++) arr.push(i); this.daysInMonth = arr; }
  async refreshData() {
    const m = await dbHelper.getMonthMarkers(this.currentYear, this.currentMonth); this.courseMarkers = m.courses;
    const start = new Date(this.currentYear, this.currentMonth - 1, 1).getTime();
    const end = new Date(this.currentYear, this.currentMonth, 0, 23, 59, 59).getTime();
    const todos = await dbHelper.getTodosByDate(start, end);
    const todoDays = new Set<number>();
    todos.forEach(t => {
      if (t.isFinished === 0) {
        const d = new Date(t.date);
        if(d.getMonth() === this.currentMonth - 1 && d.getFullYear() === this.currentYear) {
          todoDays.add(d.getDate());
        }
      }
    });
    this.inspMarkers = Array.from(todoDays);

    const dayStart = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay);
    dayStart.setHours(0,0,0,0);
    const dayEnd = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay);
    dayEnd.setHours(23,59,59,999);
    const c = await dbHelper.getCoursesByDate(dayStart.getTime(), dayEnd.getTime());
    this.todayCoursesCount = c.length;
    const todosToday = await dbHelper.getTodosByDate(dayStart.getTime(), dayEnd.getTime());
    this.todayTodosCount = todosToday.filter(t => t.isFinished === 0).length;
  }
  handlePrevMonth() { let y = this.currentYear, m = this.currentMonth - 1; if (m < 1) { y--; m = 12; } this.currentYear = y; this.currentMonth = m; this.initCalendar(); this.refreshData(); }
  handleNextMonth() { let y = this.currentYear, m = this.currentMonth + 1; if (m > 12) { y++; m = 1; } this.currentYear = y; this.currentMonth = m; this.initCalendar(); this.refreshData(); }
  onDayClick(d: number) {
    this.selectedDay = d;
    this.refreshData().then(() => {
      this.detailController = new CustomDialogController({ builder: DailyDetailDialog({ currentDate: new Date(this.currentYear, this.currentMonth - 1, this.selectedDay), onDataChanged: () => { this.refreshData(); }, onOpenAnalysis: (group) => { const targetDate = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay); this.currentAnalysisDate = targetDate.getTime(); this.currentAnalysisRecords = group.records; setTimeout(() => { this.isShowAnalysisSheet = true; }, 50); }, onAddCourse: () => { if (this.detailController) { this.detailController.close(); } const targetDate = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay); this.showAddCourseDialog(targetDate); } }), alignment: DialogAlignment.Bottom, customStyle: true });
      this.detailController.open();
    });
  }
  openTodoDialog() { this.todoController = new CustomDialogController({ builder: TodoDetailDialog({ currentDate: new Date(this.currentYear, this.currentMonth - 1, this.selectedDay), onDataChanged: () => { this.refreshData(); } }), alignment: DialogAlignment.Bottom, customStyle: true }); this.todoController.open(); }

  // 1. Ê©ôËâ≤Ê¶ÇËßàÂ§ßÂç°Áâá (Hero Card)
  @Builder HeroCard() {
    Stack({ alignContent: Alignment.TopStart }) {
      Circle({ width: 120, height: 120 })
        .fill(this.isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)')
        .position({ x: -30, y: -30 })
        .zIndex(1)

      Circle({ width: 80, height: 80 })
        .fill(this.isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)')
        .position({ x: '80%', y: '60%' })
        .zIndex(1)

      Column() {
        Row() {
          Text('‰ªäÊó•Ê¶ÇËßà').fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
          Blank()
          Text(`${this.currentMonth}Êúà${this.selectedDay}Êó•`).fontSize(12).fontColor('rgba(255,255,255,0.9)').backgroundColor('rgba(0,0,0,0.1)').padding({left:8, right:8, top:4, bottom:4}).borderRadius(10)
        }.width('100%')
        Text(`${this.todayCoursesCount} ËäÇËØæÁ®ã ¬∑ ${this.todayTodosCount} ‰∏™ÂæÖÂäû`).fontSize(13).fontColor('rgba(255,255,255,0.9)').margin({ top: 4 })
      }.alignItems(HorizontalAlign.Start).width('100%').height('100%').zIndex(2)
    }
    .width('100%').height(100).padding(20)
    .linearGradient({ angle: 135, colors: Theme.getStyle(this.themeName).heroGradient })
    .borderRadius(24).shadow({ radius: 20, color: this.isDarkMode ? Theme.colors.dark.shadow : 'rgba(0,0,0,0.2)', offsetY: 10 })
    .onClick(() => {
      const t = new Date();
      this.selectedDay = t.getDate();
      this.onDayClick(t.getDate());
    })
  }

  // 2. 1x4 ÂäüËÉΩÂÖ•Âè£Ë°å
  @Builder FunctionRow() {
    Row({ space: 10 }) {
      // 1. ÊéíËØæ
      Column() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 44, height: 44 }).fill('rgba(255,255,255,0.2)')
          SymbolGlyph($r('sys.symbol.calendar_badge_plus')).fontSize(22).fontColor([Color.White])
        }.margin({ bottom: 6 })
        Text('Âø´ÈÄüÊéíËØæ').fontSize(12).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }.layoutWeight(1).onClick(() => this.openAddCourse())

      // 2. ÁÅµÊÑü
      Column() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 44, height: 44 }).fill('rgba(255,255,255,0.2)')
          SymbolGlyph($r('sys.symbol.lightbulb')).fontSize(22).fontColor([Color.White])
        }.margin({ bottom: 6 })
        Text('Áü•ËØÜÁÅµÊÑü').fontSize(12).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }.layoutWeight(1).onClick(() => this.openAddKnowledge())

      // 3. ÂæÖÂäû
      Column() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 44, height: 44 }).fill('rgba(255,255,255,0.2)')
          SymbolGlyph($r('sys.symbol.list_bullet')).fontSize(22).fontColor([Color.White])
        }.margin({ bottom: 6 })
        Text('ÂæÖÂäû‰∫ãÈ°π').fontSize(12).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }.layoutWeight(1).onClick(() => this.openTodoDialog())

      // 4. ÂàÜÊûê
      Column() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 44, height: 44 }).fill('rgba(255,255,255,0.2)')
          SymbolGlyph($r('sys.symbol.doc_plaintext')).fontSize(22).fontColor([Color.White])
        }.margin({ bottom: 6 })
        Text('Â≠¶ÊÉÖÂàÜÊûê').fontSize(12).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }.layoutWeight(1).onClick(() => this.openReportCenter())

    }
    .width('100%')
    .padding({ top: 15, bottom: 15 })
    .linearGradient({ angle: 90, colors: Theme.getStyle(this.themeName).heroGradient })
    .borderRadius(24)
    .shadow({ radius: 15, color: this.isDarkMode ? Theme.colors.dark.shadow : 'rgba(0,0,0,0.15)', offsetY: 5 })
  }

  // 3. ÊÇ¨ÊµÆ Dock Ê†è
  @Builder FloatingDock() {
    Row() {
      // 1. Êó•Á®ã Tab
      this.DockItem($r('sys.symbol.calendar'), 'Êó•Á®ã', 0)

      // 2. Â≠¶Âëò Tab
      this.DockItem($r('sys.symbol.person_2_fill'), 'Â≠¶Âëò', 1)

      // 3. ÂæÖÂäû Tab
      this.DockItem($r('sys.symbol.list_bullet'), 'ÂæÖÂäû', 2)
    }
    .width('65%') // ËÉ∂ÂõäÂÆΩÂ∫¶
    .height(64)
    .backgroundColor(this.isDarkMode ? Theme.colors.dark.dockBg : Theme.colors.light.dockBg) // ÈÄÇÈÖçÈªëÂ§úÊ®°ÂºèDockËÉåÊôØ
    .backdropBlur(20) // ÊØõÁéªÁíÉ
    .borderRadius(32) // ÂúÜËßí
    .shadow({ radius: 20, color: 'rgba(0,0,0,0.1)', offsetY: 5 })
    .justifyContent(FlexAlign.SpaceEvenly)
    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂº∫Âà∂ zIndex ÁΩÆÈ°∂ÔºåÁ°Æ‰øù‰∏çË¢´È°µÈù¢ÂÜÖÂÆπÈÅÆÊå°
    .zIndex(9999)
    .margin({ bottom: 14 })
  }

  @Builder DockItem(icon: Resource, text: string, index: number) {
    Column() {
      SymbolGlyph(icon)
        .fontSize(24)
        .fontColor(this.currentTabIndex === index ? [Theme.getStyle(this.themeName).accent as ResourceColor] : (this.isDarkMode ? [Theme.colors.dark.textSecondary] : [Theme.colors.light.textSecondary]))
        .animation({ duration: 300, curve: Curve.FastOutSlowIn })

      Text(text)
        .fontSize(10)
        .fontColor(this.currentTabIndex === index ? Theme.getStyle(this.themeName).accent as ResourceColor : (this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary))
        .margin({ top: 4 })
    }
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .width(60)
    .onClick(() => {
      this.currentTabIndex = index;
    })
    .stateStyles({
      pressed: { .scale({ x: 0.85, y: 0.85 }) },
      normal: { .scale({ x: 1.0, y: 1.0 }) }
    })
    .animation({ duration: 200 })
  }

  @Builder CalendarView() {
    Column() {
      // Êó•ÊúüÂ§¥ + ÊòüÊúü
      Column() {
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(20).fontColor([this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary]).onClick(() => { this.handlePrevMonth() }).padding(10)
          Text(`${this.currentYear}Âπ¥ ${this.currentMonth}Êúà`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)
          SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(20).fontColor([this.isDarkMode ? Theme.colors.dark.textSecondary : Theme.colors.light.textSecondary]).onClick(() => { this.handleNextMonth() }).padding(10)
        }.width('100%').justifyContent(FlexAlign.Center).margin({bottom: 10})

        Row() {
          ForEach(['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], (d: string) => {
            Text(d).fontSize(12).fontWeight(FontWeight.Bold).fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary).opacity(0.6).layoutWeight(1).textAlign(TextAlign.Center)
          })
        }.width('100%').margin({ bottom: 10 })
      }

      Grid() {
        ForEach(Array(this.startWeekDay).fill(0), (item: number) => { GridItem() })
        ForEach(this.daysInMonth, (d: number) => {
          GridItem() {
            Column() {
              Text(d.toString()).fontSize(16).fontWeight(this.selectedDay === d ? FontWeight.Bold : FontWeight.Normal).fontColor(this.selectedDay === d ? Color.White : (this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)).width(36).height(36).textAlign(TextAlign.Center)
                .backgroundColor(this.selectedDay === d ? Theme.getStyle(this.themeName).accent as ResourceColor : 'transparent') // „Äê‰∏ªÈ¢òËâ≤„Äë
                .borderRadius(18)
              Row({ space: 2 }) {
                if (this.courseMarkers.includes(d)) Circle({ width: 4, height: 4 }).fill('#007DFF')
                if (this.inspMarkers.includes(d)) Circle({ width: 4, height: 4 }).fill('#FF9900')
              }.height(6)
            }.width('100%').height(60).justifyContent(FlexAlign.Start).onClick(() => { this.onDayClick(d) })
          }
        })
      }.columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr').height(this.gridHeight)
    }
    .width('100%').padding(15).backgroundColor(this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card).borderRadius(24).shadow({ radius: 20, color: this.isDarkMode ? Theme.colors.dark.shadow : Theme.colors.light.shadow, offsetY: 2 })
  }

  @Builder AnalysisSheetBuilder() {
    PostClassAnalysisSheet({
      courseDate: this.currentAnalysisDate,
      records: this.currentAnalysisRecords,
      onClose: () => {
        this.isShowAnalysisSheet = false;
      }
    })
  }

  // 4. È¶ñÈ°µËßÜÂõæ (HomeView) - „Äê‰øÆÂ§ç„ÄëÁßªÈô§ Scroll ÁªÑ‰ª∂ÔºåÂõ∫ÂÆöÂ∏ÉÂ±Ä
  @Builder HomeView() {
    Column() {
      // Ê†áÈ¢òÊ†è + ‰∏ªÈ¢òÂàáÊç¢ÂÖ•Âè£
      Row() {
        Text("ËØæÊó∂ËÆ∞")
          .fontSize(26)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isDarkMode ? Theme.colors.dark.textPrimary : Theme.colors.light.textPrimary)

        // „ÄêÊñ∞Â¢û„Äë‰∏ìÈó®ÁöÑ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
        Button({ type: ButtonType.Circle }) {
          SymbolGlyph($r('sys.symbol.circle_grid_2x2')) // ‰øÆÂ§çÂêéÁöÑÂõæÊ†á
            .fontSize(20)
            .fontColor([Theme.getStyle(this.themeName).accent as ResourceColor])
        }
        .width(36)
        .height(36)
        .backgroundColor(this.isDarkMode ? Theme.colors.dark.inputBg : Theme.colors.light.inputBg)
        .margin({ left: 10 })
        .onClick(() => this.openThemeSetting())
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 60, bottom: 10 })

      Column({ space: 12 }) {
        this.CalendarView()
        this.HeroCard() // ÁÇπÂáªÂÆÉÁé∞Âú®‰ºöÊâìÂºÄ‚Äú‰ªäÊó•ËØ¶ÊÉÖ‚Äù
        this.FunctionRow()
        Blank().height(120)
      }
      .padding({ left: 20, right: 20 })
      .width('100%')
    }
  }

  build() {
    // ‰ΩøÁî® Stack ÂÆûÁé∞ÂÜÖÂÆπÂ±Ç‰∏éÊÇ¨ÊµÆÂ±ÇÂàÜÁ¶ª
    Stack({ alignContent: Alignment.Bottom }) {

      // 1. Â∫ïÂ±ÇÔºöÁã¨Á´ãËÉåÊôØÂ±Ç (Ëß£ÂÜ≥Ê∏êÂèòËâ≤Â±ÇÁ∫ßÈóÆÈ¢ò)
      Column()
        .width('100%')
        .height('100%')
        // „ÄêÂÖ≥ÈîÆ„Äë‰ΩøÁî® Theme ‰∏≠ÁöÑÂä®ÊÄÅÊ∏êÂèòËâ≤
        .linearGradient({ angle: 180, colors: this.isDarkMode ? Theme.colors.dark.bgGradient : Theme.colors.light.bgGradient })

      // 2. ‰∏≠Â±ÇÔºöÂÜÖÂÆπÂ±Ç
      Column() {
        // È°µÈù¢ÂàáÊç¢ÈÄªËæë
        if (this.currentTabIndex === 0) {
          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÁßªÈô§ ScrollÔºåÂÆûÁé∞Âõ∫ÂÆöÂ∏ÉÂ±Ä
          this.HomeView()
        } else if (this.currentTabIndex === 1) {
          StudentPage() // ÂºïÁî®Â≠¶ÂëòÈ°µ
        } else if (this.currentTabIndex === 2) {
          TodoPage() // ÂºïÁî®ÂæÖÂäûÈ°µ
        }
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Start)
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])

      // 3. È°∂Â±ÇÔºöÊÇ¨ÊµÆ Dock Â±Ç (ÊúÄ‰∏äÂ±Ç) - „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂº∫Âà∂ÁΩÆÈ°∂
      this.FloatingDock()
    }
    .width('100%')
    .height('100%')

    // ÁªëÂÆö Sheet
    .bindSheet($$this.isShowAnalysisSheet, this.AnalysisSheetBuilder(), {
      detents: [SheetSize.MEDIUM, SheetSize.LARGE], dragBar: true, showClose: false, backgroundColor: this.isDarkMode ? Theme.colors.dark.card : Theme.colors.light.card, onDisappear: () => { this.isShowAnalysisSheet = false }
    })
  }
}

// =======================
// 11. È°µÈù¢ÂÖ•Âè£ (Entry) - „Äê‰øÆÂ§çÊ†πËäÇÁÇπÈîôËØØ„Äë
// =======================
@Entry
@Component
struct CalendarPage {
  build() {
    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂøÖÈ°ªÁî®‰∏Ä‰∏™ÂÆπÂô®ÁªÑ‰ª∂ÔºàÂ¶Ç ColumnÔºâ‰Ωú‰∏∫Ê†πËäÇÁÇπ
    Column() {
      CalendarView()
    }
    .width('100%')
    .height('100%')
    // Á°Æ‰øùËÉåÊôØËâ≤ÈÄèÊòéÔºåÈÄèÂá∫ CalendarView ÈáåÁöÑÊ∏êÂèòËÉåÊôØÔºåÊàñËÄÖÂú®ËøôÈáåËÆæÁΩÆËÉåÊôØ‰πüÂèØ‰ª•
    .backgroundColor(Color.Transparent)
  }
}
