/**
 * è¯¾æ—¶è®° (Class Recorder) - ç¼–è¯‘ä¿®å¤å®Œæ•´ç‰ˆ
 * * ä¿®å¤æ—¥å¿—ï¼š
 * 1. ç¼–è¯‘ä¿®å¤ï¼šåœ¨ NotificationService ä¸­åŠ å› startClassReminder æ–¹æ³•ã€‚
 * - åŸå› ï¼šè¯¦æƒ…é¡µçš„â€œæ‰‹åŠ¨æé†’â€æŒ‰é’®ä»åœ¨ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ­¤å‰å› é‡æ„è¢«è¯¯åˆ ã€‚
 * - ç°åœ¨ï¼šscheduleAutoReminder ç”¨äºæ’è¯¾æ—¶è‡ªåŠ¨é¢„çº¦ï¼ŒstartClassReminder ç”¨äºæ‰‹åŠ¨ç‚¹å‡»å‘é€ç«‹å³é€šçŸ¥ã€‚
 * 2. å®Œæ•´æ€§ï¼šä¿ç•™æ‰€æœ‰ä¹‹å‰çš„ UI ç¾åŒ–ã€å…¨å±å¼¹çª—ã€æ•°æ®å¯¼å‡ºç­‰åŠŸèƒ½ã€‚
 */

import promptAction from '@ohos.promptAction';
import notificationManager from '@ohos.notificationManager';
import notification from '@ohos.notification';
import reminderAgentManager from '@ohos.reminderAgentManager'; // åå°ä»£ç†æé†’
import window from '@ohos.window';
import fs from '@ohos.file.fs';
import picker from '@ohos.file.picker';

// --- 1. æ•°æ®æ¨¡å‹å®šä¹‰ ---
class Student {
  id: number = 0;
  name: string = '';
  totalHours: number = 0;
  remainingHours: number = 0;
  paymentDate: string = '';
  note: string = '';
  paymentAmount: number = 0;

  constructor(name: string, totalHours: number, note: string, paymentAmount: number = 0) {
    this.id = Date.now();
    this.name = name;
    this.totalHours = totalHours;
    this.remainingHours = totalHours;
    this.paymentDate = new Date().toISOString().split('T')[0];
    this.note = note;
    this.paymentAmount = paymentAmount;
  }
}

class CalendarEvent {
  id: number = 0;
  date: string = '';
  type: 'class' | 'inspiration' = 'class';
  studentId: number | null = null;
  content: string = '';
  time: string = '';
  status: 'scheduled' | 'completed' = 'scheduled';

  constructor(type: 'class' | 'inspiration', date: string) {
    this.id = Date.now() + Math.random();
    this.type = type;
    this.date = date;
  }
}

class EventGroup {
  id: string;
  time: string;
  type: 'class' | 'inspiration';
  events: CalendarEvent[];

  constructor(time: string, type: 'class' | 'inspiration', events: CalendarEvent[]) {
    this.time = time;
    this.type = type;
    this.events = events;
    this.id = type + '_' + time + '_' + (events.length > 0 ? events[0].id : '0');
  }
}

PersistentStorage.PersistProp('students_data', []);
PersistentStorage.PersistProp('events_data', []);

// --- 2. ä¸šåŠ¡é€»è¾‘ ---
class NotificationService {
  static readonly NOTIFICATION_ID = 1001;
  
  // [ä¿®å¤] æ‰‹åŠ¨ç«‹å³å‘é€æé†’ (ç”¨äºåˆ—è¡¨æŒ‰é’®)
  static async startClassReminder(studentName: string, time: string) {
    try {
      await notificationManager.requestEnableNotification();
      let notificationRequest: notificationManager.NotificationRequest = {
        id: NotificationService.NOTIFICATION_ID,
        slotType: notification.SlotType.SOCIAL_COMMUNICATION,
        content: {
          contentType: notification.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: `å³å°†ä¸Šè¯¾`,
            text: `æ—¶é—´ï¼š${time} | å­¦ç”Ÿï¼š${studentName}`,
            additionalText: "è¯¾æ—¶è®°æé†’"
          }
        },
        extraInfo: {
          "studentName": studentName,
          "classTime": time
        }
      };
      await notificationManager.publish(notificationRequest);
      try { promptAction.showToast({ message: 'å·²å‘é€ä¸Šè¯¾æé†’é€šçŸ¥' }); } catch (e) {}
    } catch (err) {
      console.error(`å‘å¸ƒé€šçŸ¥å¤±è´¥: ${JSON.stringify(err)}`);
      try { promptAction.showToast({ message: 'é€šçŸ¥å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™' }); } catch (e) {}
    }
  }

  // è‡ªåŠ¨é¢„çº¦æé†’ï¼šè¯¾ç¨‹å‰ä¸€å¤©çš„æ™šä¸Š 20:00 æ¨é€ (ç”¨äºæ’è¯¾æ—¶)
  static async scheduleAutoReminder(studentName: string, classDateStr: string, classTimeStr: string) {
    try {
      // 1. è§£ææ—¶é—´
      const dateParts = classDateStr.split('-').map(Number); // [2023, 12, 05]
      const timeParts = classTimeStr.split(':').map(Number); // [10, 00]
      
      // æ„é€ è¯¾ç¨‹æ—¶é—´ (æ³¨æ„æœˆä»½ -1)
      const classDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2], timeParts[0], timeParts[1]);
      
      // 2. è®¡ç®—æé†’æ—¶é—´ (å‰ä¸€å¤© 20:00)
      const reminderDate = new Date(classDate.getTime());
      reminderDate.setDate(reminderDate.getDate() - 1);
      reminderDate.setHours(20, 0, 0, 0);

      // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œä¸æé†’
      if (reminderDate.getTime() < Date.now()) {
        return;
      }

      // 3. æ„å»ºåå°æé†’è¯·æ±‚
      let reminderRequest: reminderAgentManager.ReminderRequestCalendar = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
        dateTime: {
          year: reminderDate.getFullYear(),
          month: reminderDate.getMonth() + 1,
          day: reminderDate.getDate(),
          hour: reminderDate.getHours(),
          minute: reminderDate.getMinutes()
        },
        title: "ğŸ”” æ˜æ—¥ä¸Šè¯¾æé†’",
        content: `å­¦ç”Ÿ ${studentName} çš„è¯¾ç¨‹å°†äºæ˜å¤© ${classTimeStr} å¼€å§‹ï¼Œè¯·åšå¥½å‡†å¤‡ã€‚`,
        actionButton: [
          { title: "çŸ¥é“äº†", type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE }
        ],
        snoozeTimes: 0,
        ringDuration: 5
      };

      // 4. å‘å¸ƒé¢„çº¦
      await reminderAgentManager.publishReminder(reminderRequest);
      console.info('Reminder scheduled success');

    } catch (e) {
      console.error('Schedule error:', JSON.stringify(e));
      // æƒé™æœªé…ç½®æ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹
    }
  }
}

class DataExporter {
  static async exportStudentData(student: Student, events: CalendarEvent[]) {
    try {
      const studentEvents = events.filter(e => e.studentId === student.id && e.type === 'class');
      
      let content = '\uFEFF'; // BOM å¤´é˜²æ­¢ä¹±ç 
      content += `å­¦ç”Ÿæ•°æ®å¯¼å‡ºæŠ¥è¡¨\n`;
      content += `ç”Ÿæˆæ—¥æœŸ,${new Date().toLocaleDateString()}\n\n`;
      content += `[åŸºæœ¬ä¿¡æ¯]\n`;
      content += `å§“å,${student.name}\n`;
      content += `ç¼´è´¹æ—¥æœŸ,${student.paymentDate}\n`;
      content += `ç¼´è´¹é‡‘é¢,${student.paymentAmount}\n`;
      content += `æ€»è¯¾æ—¶,${student.totalHours}\n`;
      content += `å‰©ä½™è¯¾æ—¶,${student.remainingHours}\n`;
      content += `å·²ä¸Šè¯¾æ—¶,${student.totalHours - student.remainingHours}\n`;
      content += `å¤‡æ³¨,${student.note}\n\n`;
      content += `[ä¸Šè¯¾è®°å½•æ˜ç»†]\n`;
      content += `æ—¥æœŸ,æ—¶é—´,çŠ¶æ€\n`;

      studentEvents.sort((a, b) => a.date.localeCompare(b.date));

      studentEvents.forEach(ev => {
        const statusStr = ev.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…ä¸Šè¯¾';
        content += `${ev.date},${ev.time},${statusStr}\n`;
      });

      const saveOptions = new picker.DocumentSaveOptions();
      saveOptions.newFileNames = [`${student.name}_è¯¾æ—¶æ•°æ®.csv`];
      const documentViewPicker = new picker.DocumentViewPicker();
      const documentSaveResult = await documentViewPicker.save(saveOptions);

      if (documentSaveResult && documentSaveResult.length > 0) {
        const uri = documentSaveResult[0];
        const file = fs.openSync(uri, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
        fs.writeSync(file.fd, content);
        fs.closeSync(file);
        promptAction.showToast({ message: 'å¯¼å‡ºæˆåŠŸ' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'å¯¼å‡ºå¤±è´¥' });
    }
  }
}

// --- 3. UI ç»„ä»¶ ---

@CustomDialog
struct StudentDataDialog {
  controller: CustomDialogController;
  @Link student: Student;
  @Link allEvents: CalendarEvent[];

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text(this.student.name + ' / æ¡£æ¡ˆ').fontSize(22).fontWeight(FontWeight.Bold).fontColor('#111827')
        Text('å…³é—­').fontSize(14).fontColor('#4B5563').backgroundColor('#F3F4F6')
          .padding({ left: 14, right: 14, top: 6, bottom: 6 }).borderRadius(14)
          .onClick(() => this.controller.close())
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })

      Scroll() {
        Column({ space: 16 }) {
          // ç»Ÿè®¡å¡ç‰‡
          Row() {
            Column() {
              Text('æ€»è¯¾æ—¶').fontSize(12).fontColor('#6B7280').margin({ bottom: 6 })
              Text(`${this.student.totalHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
            Divider().vertical(true).height(30).color('#E5E7EB')
            Column() {
              Text('å·²æ¶ˆ').fontSize(12).fontColor('#6B7280').margin({ bottom: 6 })
              Text(`${this.student.totalHours - this.student.remainingHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#059669')
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
            Divider().vertical(true).height(30).color('#E5E7EB')
            Column() {
              Text('å‰©ä½™').fontSize(12).fontColor('#6B7280').margin({ bottom: 6 })
              Text(`${this.student.remainingHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#2563EB')
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
          }.width('100%').padding(20).backgroundColor('#F9FAFB').borderRadius(16)

          // è´¹ç”¨ä¿¡æ¯
          Row() {
            Text('ç¼´è´¹: ' + this.student.paymentDate).fontSize(13).fontColor('#6B7280')
            Blank()
            Text('Â¥' + this.student.paymentAmount).fontSize(15).fontColor('#111827').fontWeight(FontWeight.Bold)
          }.width('100%').padding({ left: 8, right: 8 })

          Text('è®°å½•æ˜ç»†').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#111827').width('100%').margin({ top: 12 })

          List({ space: 10 }) {
            ForEach(this.allEvents.filter(e => e.studentId === this.student.id && e.type === 'class'), (ev: CalendarEvent) => {
              ListItem() {
                Row() {
                  Column() {
                    Text(ev.date).fontSize(14).fontWeight(FontWeight.Medium).fontColor('#1F2937')
                    Text(ev.time).fontSize(12).fontColor('#9CA3AF').margin({ top: 2 })
                  }.alignItems(HorizontalAlign.Start)
                  Blank()
                  if (ev.status === 'completed') {
                    Text('å·²æ¶ˆ').fontSize(11).fontColor('#059669').backgroundColor('#D1FAE5').padding({ left: 8, right: 8, top: 2, bottom: 2 }).borderRadius(4)
                  } else {
                    Text('å¾…ä¸Š').fontSize(11).fontColor('#D97706').backgroundColor('#FEF3C7').padding({ left: 8, right: 8, top: 2, bottom: 2 }).borderRadius(4)
                  }
                }
                .width('100%').padding(12).backgroundColor('#FFFFFF').borderRadius(12).border({ width: 1, color: '#F3F4F6' })
              }
            })
          }.width('100%').height(240)
        }
      }.layoutWeight(1).scrollBar(BarState.Off)

      Button('å¯¼å‡ºæ•°æ® (CSV)').width('100%').height(48).backgroundColor('#059669').fontColor(Color.White).fontSize(16).fontWeight(FontWeight.Bold).margin({ top: 20 }).borderRadius(24)
        .onClick(() => { DataExporter.exportStudentData(this.student, this.allEvents); })

    }
    .width('100%')
    .height('100%')
    .padding({ left: 24, right: 24, bottom: 32, top: 48 })
    .backgroundColor(Color.White)
  }
}

@CustomDialog
struct AddDialog {
  controller: CustomDialogController;
  type: 'class' | 'inspiration' | 'student_add' = 'class';
  @Link students: Student[];
  @Link events: CalendarEvent[];
  selectedDate: Date = new Date();

  @State nameInput: string = '';
  @State hoursInput: string = '';
  @State noteInput: string = '';
  @State amountInput: string = '';
  @State selectedStudentIds: number[] = [];
  @State timeInput: string = '10:00';
  @State contentInput: string = '';

  build() {
    Column() {
      Text(this.type === 'class' ? 'æ’ä¸€èŠ‚è¯¾' : (this.type === 'inspiration' ? 'è®°å½•çµæ„Ÿ' : 'æ–°å¢å­¦ç”Ÿ'))
        .fontSize(22).fontWeight(FontWeight.Bold).fontColor('#111827').margin({ bottom: 24, top: 8 }).width('100%').textAlign(TextAlign.Start)

      if (this.type === 'student_add') {
        Column({ space: 14 }) {
          TextInput({ placeholder: 'å­¦ç”Ÿå§“å', text: this.nameInput })
            .backgroundColor('#F3F4F6').borderRadius(12).height(50).width('100%').onChange((val) => this.nameInput = val)
          Row({ space: 12 }) {
            TextInput({ placeholder: 'è´­ä¹°è¯¾æ—¶', text: this.hoursInput })
              .type(InputType.Number).backgroundColor('#F3F4F6').borderRadius(12).height(50).layoutWeight(1).onChange((val) => this.hoursInput = val)
            TextInput({ placeholder: 'ç¼´è´¹é‡‘é¢', text: this.amountInput })
              .type(InputType.Number).backgroundColor('#F3F4F6').borderRadius(12).height(50).layoutWeight(1).onChange((val) => this.amountInput = val)
          }
          TextInput({ placeholder: 'å¤‡æ³¨ (é€‰å¡«)', text: this.noteInput })
            .backgroundColor('#F3F4F6').borderRadius(12).height(50).width('100%').onChange((val) => this.noteInput = val)
        }
      } else if (this.type === 'class') {
        Column({ space: 12 }) {
          Text('é€‰æ‹©å­¦ç”Ÿ').fontSize(14).fontColor('#6B7280').width('100%').margin({ bottom: 4 })
          if (this.students.length === 0) {
            Text('æš‚æ— å­¦ç”Ÿï¼Œè¯·å…ˆæ·»åŠ ').fontSize(14).fontColor('#2563EB').backgroundColor('#EFF6FF').padding(12).borderRadius(12).width('100%').textAlign(TextAlign.Center)
          } else {
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.students, (s: Student) => {
                Text(s.name).fontSize(14).fontWeight(this.selectedStudentIds.includes(s.id) ? FontWeight.Bold : FontWeight.Normal)
                  .fontColor(this.selectedStudentIds.includes(s.id) ? Color.White : '#374151').padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .backgroundColor(this.selectedStudentIds.includes(s.id) ? '#2563EB' : '#F3F4F6').borderRadius(20).margin({ right: 8, bottom: 8 })
                  .onClick(() => {
                     if (this.selectedStudentIds.includes(s.id)) { this.selectedStudentIds = this.selectedStudentIds.filter(id => id !== s.id); }
                     else { this.selectedStudentIds.push(s.id); }
                  })
              })
            }.margin({ bottom: 8 })
          }
          TextInput({ text: this.timeInput, placeholder: 'æ—¶é—´' })
            .backgroundColor('#F3F4F6').fontColor('#000000').fontSize(18).textAlign(TextAlign.Center).borderRadius(12).height(50).width('100%')
            .onChange((val: string) => this.timeInput = val)
        }
      } else {
        TextArea({ placeholder: 'å†™ä¸‹ä½ çš„æƒ³æ³•...' }).height(120).backgroundColor('#F3F4F6').borderRadius(12).padding(16)
          .onChange((val: string) => this.contentInput = val)
      }

      Row({ space: 16 }) {
        Button('å–æ¶ˆ').backgroundColor('#F3F4F6').fontColor('#4B5563').layoutWeight(1).height(48).borderRadius(24).onClick(() => this.controller.close())
        Button('ç¡®è®¤').backgroundColor('#2563EB').fontColor(Color.White).layoutWeight(1).height(48).borderRadius(24).onClick(() => this.handleSubmit())
      }.margin({ top: 24 }).width('100%')
    }.padding(24).backgroundColor(Color.White).borderRadius(24).width('85%')
  }

  handleSubmit() {
    if (this.type === 'student_add') {
      if (!this.nameInput) return;
      const exists = this.students.some(s => s.name === this.nameInput);
      if (exists) { try { promptAction.showToast({ message: 'å­¦ç”Ÿå·²å­˜åœ¨' }); } catch(e){} return; }
      this.students.push(new Student(this.nameInput, parseInt(this.hoursInput) || 0, this.noteInput, parseInt(this.amountInput) || 0));
    } else if (this.type === 'class') {
      if (this.selectedStudentIds.length === 0) return;
      this.selectedStudentIds.forEach(id => {
        const evt = new CalendarEvent('class', this.selectedDate.toISOString().split('T')[0]);
        evt.studentId = id;
        evt.time = this.timeInput;
        this.events.push(evt);
        // è‡ªåŠ¨é¢„çº¦åå°æé†’
        const student = this.students.find(s => s.id === id);
        if (student) {
          NotificationService.scheduleAutoReminder(student.name, evt.date, evt.time);
        }
      });
      try { promptAction.showToast({ message: 'æ’è¯¾æˆåŠŸï¼Œå·²è‡ªåŠ¨è®¾ç½®æé†’' }); } catch(e){}
    } else {
      if (!this.contentInput) return;
      const evt = new CalendarEvent('inspiration', this.selectedDate.toISOString().split('T')[0]);
      evt.content = this.contentInput;
      this.events.push(evt);
    }
    this.controller.close();
  }
}

@Entry
@Component
struct ClassRecorderApp {
  @StorageLink('students_data') students: Student[] = [];
  @StorageLink('events_data') events: CalendarEvent[] = [];

  @State currentTabIndex: number = 0;
  private tabsController: TabsController = new TabsController();

  @State currentDate: Date = new Date();
  @State selectedDate: Date = new Date();
  @State isSheetShown: boolean = false;
  @State dialogType: 'class' | 'inspiration' | 'student_add' = 'class';

  @State currentViewingStudent: Student = new Student('', 0, '');
  @State currentViewingEvents: CalendarEvent[] = [];

  studentDataDialogController: CustomDialogController = new CustomDialogController({
    builder: StudentDataDialog({
      student: $currentViewingStudent,
      allEvents: $currentViewingEvents
    }),
    alignment: DialogAlignment.Center,
    customStyle: true,
    autoCancel: true
  });

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddDialog({ type: this.dialogType, students: $students, events: $events, selectedDate: this.selectedDate }),
    alignment: DialogAlignment.Center,
    customStyle: true,
    autoCancel: true
  });

  setStatusBar() {
    try {
      window.getLastWindow(getContext(this)).then((win) => {
        win.setWindowLayoutFullScreen(true);
        win.setWindowSystemBarProperties({ statusBarColor: '#00FFFFFF', statusBarContentColor: '#000000', navigationBarColor: '#FFFFFF', navigationBarContentColor: '#000000' })
      })
    } catch (err) {}
  }

  aboutToAppear() { this.setStatusBar(); }
  onPageShow() { this.setStatusBar(); }

  openDialog(type: 'class' | 'inspiration' | 'student_add') {
    this.dialogType = type;
    this.dialogController.open();
  }

  openStudentData(index: number) {
    this.currentViewingStudent = this.students[index];
    this.currentViewingEvents = this.events;
    this.studentDataDialogController.open();
  }

  getDaysInMonth(date: Date): (Date | null)[] {
    const year = date.getFullYear();
    const month = date.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay();
    const days: (Date | null)[] = [];
    for (let i = 0; i < firstDayIndex; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
    return days;
  }

  formatDate(date: Date): string { return date.toISOString().split('T')[0]; }
  getEventsForDay(date: Date | null): CalendarEvent[] {
    if (!date) return [];
    return this.events.filter(e => e.date === this.formatDate(date));
  }

  getGroupedEvents(date: Date): EventGroup[] {
    const rawEvents = this.getEventsForDay(date);
    const groups: EventGroup[] = [];
    const classEvents = rawEvents.filter(e => e.type === 'class');
    const inspirationEvents = rawEvents.filter(e => e.type === 'inspiration');
    const timeMap = new Map<string, CalendarEvent[]>();
    classEvents.forEach(ev => { if (!timeMap.has(ev.time)) { timeMap.set(ev.time, []); } timeMap.get(ev.time)?.push(ev); });
    timeMap.forEach((events, time) => { groups.push(new EventGroup(time, 'class', events)); });
    inspirationEvents.forEach(ev => { groups.push(new EventGroup(ev.time || 'å…¨å¤©', 'inspiration', [ev])); });
    return groups.sort((a, b) => a.time.localeCompare(b.time));
  }

  // --- é¦–é¡µæ—¥å†è§†å›¾ ---
  @Builder CalendarView() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜æ  (æ¢å¤å·¦ä¾§æ ‡é¢˜ + å³ä¾§å¤´åƒ)
      Row() {
        Text('è¯¾æ—¶è®°')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#111827')
        
        // ä¿®å¤ï¼šä½¿ç”¨ Stack æ›¿ä»£ overlay
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 40, height: 40 })
            .fill('#F3F4F6')
          Text('U')
            .fontSize(14)
            .fontColor('#9CA3AF')
        }
        .width(40)
        .height(40)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 24, right: 24, top: 48, bottom: 10 })

      Scroll() {
        Column() {
          // æœˆä»½åˆ‡æ¢
          Row() {
            Button('<').type(ButtonType.Circle).backgroundColor('#F3F4F6').fontColor('#6B7280').width(36).height(36).onClick(() => {
                let d = new Date(this.currentDate); d.setMonth(d.getMonth() - 1); this.currentDate = d;
            })
            Column() {
              Text(`${this.currentDate.getMonth() + 1}æœˆ`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
              Text(`${this.currentDate.getFullYear()}`).fontSize(12).fontColor('#9CA3AF').letterSpacing(1)
            }.alignItems(HorizontalAlign.Center).margin({ left: 20, right: 20 })
            Button('>').type(ButtonType.Circle).backgroundColor('#F3F4F6').fontColor('#6B7280').width(36).height(36).onClick(() => {
                let d = new Date(this.currentDate); d.setMonth(d.getMonth() + 1); this.currentDate = d;
            })
          }.width('100%').justifyContent(FlexAlign.Center).margin({ top: 10, bottom: 20 })

          // æ˜ŸæœŸ
          Flex({ justifyContent: FlexAlign.SpaceAround }) {
            ForEach(['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'], (day: string) => { Text(day).fontSize(12).fontColor('#9CA3AF').fontWeight(FontWeight.Medium) })
          }.padding({ left: 10, right: 10 }).margin({ bottom: 10 })

          // æ—¥å†ç½‘æ ¼
          Grid() {
            ForEach(this.getDaysInMonth(this.currentDate), (date: Date | null) => {
              GridItem() {
                if (date) {
                  Column() {
                    Text(`${date.getDate()}`).fontSize(16).fontWeight(FontWeight.Medium)
                      .fontColor(this.formatDate(date) === this.formatDate(new Date()) ? Color.White : '#1F2937')
                      .width(40).height(40).textAlign(TextAlign.Center).borderRadius(20)
                      .backgroundColor(this.formatDate(date) === this.formatDate(new Date()) ? '#2563EB' : Color.Transparent)
                    Row({ space: 4 }) {
                      if (this.getEventsForDay(date).some(e => e.type === 'class')) Circle({ width: 5, height: 5 }).fill('#3B82F6')
                      if (this.getEventsForDay(date).some(e => e.type === 'inspiration')) Circle({ width: 5, height: 5 }).fill('#F97316')
                    }.margin({ top: 4 })
                  }.height(64).width('100%').justifyContent(FlexAlign.Start).onClick(() => { this.selectedDate = date; this.isSheetShown = true; })
                }
              }
            })
          }.columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr').rowsGap(8).padding({ left: 10, right: 10 }).height(350) 

          // ä»Šæ—¥æ¦‚è§ˆå…¥å£
          Row() {
            Column() {
              Text('ä»Šæ—¥æ¦‚è§ˆ').fontSize(12).fontColor('#3B82F6').fontWeight(FontWeight.Bold).margin({ bottom: 4 })
              Text(`${this.getEventsForDay(new Date()).length} é¡¹æ—¥ç¨‹`).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#1F2937')
            }.alignItems(HorizontalAlign.Start)
            Text('ğŸ“…').fontSize(32)
          }
          .width('90%').backgroundColor(Color.White).borderRadius(20).padding(24).justifyContent(FlexAlign.SpaceBetween).margin({ top: 20 })
          .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
          .onClick(() => { this.selectedDate = new Date(); this.isSheetShown = true; })
        }
        .padding({ bottom: 150 }) 
      }
      .scrollBar(BarState.Off).layoutWeight(1).edgeEffect(EdgeEffect.Spring)
    }.height('100%').backgroundColor('#F1F3F5') // æµ…ç°èƒŒæ™¯
  }

  // --- å­¦ç”Ÿç®¡ç†è§†å›¾ ---
  @Builder StudentsView() {
    Column() {
      Row() {
        Text('å­¦ç”Ÿç®¡ç†').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
        Button('+ æ–°å¢').height(36).fontSize(14).backgroundColor('#2563EB').onClick(() => this.openDialog('student_add'))
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ left: 24, right: 24, top: 48, bottom: 20 })

      List({ space: 12 }) {
        ForEach(this.students, (student: Student, index: number) => {
          ListItem() {
            Row() {
              Text(student.name.substring(0, 1)).width(48).height(48).fontSize(20).fontWeight(FontWeight.Bold).textAlign(TextAlign.Center).fontColor('#4B5563').backgroundColor('#FFFFFF').borderRadius(24).margin({ right: 16 })
              Column() {
                Row() {
                  Text(student.name).fontSize(16).fontWeight(FontWeight.Bold)
                  if (student.remainingHours <= 3) {
                    Text('ä½™é¢ä¸è¶³').fontSize(10).fontColor('#DC2626').backgroundColor('#FEE2E2').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(4).margin({ left: 8 })
                  }
                }
                Text(student.note || 'æ— å¤‡æ³¨').fontSize(12).fontColor('#9CA3AF').margin({ top: 4 })
              }.alignItems(HorizontalAlign.Start).layoutWeight(1)
              Column() {
                Text('å‰©ä½™').fontSize(10).fontColor('#9CA3AF')
                Text() { Span(`${student.remainingHours}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(student.remainingHours <= 3 ? '#EF4444' : '#2563EB'); Span(` / ${student.totalHours}`).fontSize(12).fontColor('#9CA3AF') }
              }
            }.padding(16).width('100%').backgroundColor(Color.White).borderRadius(16).shadow({ radius: 5, color: 'rgba(0,0,0,0.03)', offsetY: 2 })
            .onClick(() => { this.openStudentData(index); })
          }.swipeAction({ end: this.DeleteAction(index, 'student') })
        })
      }.width('100%').padding({ left: 16, right: 16, bottom: 100 }).layoutWeight(1).edgeEffect(EdgeEffect.Spring)
    }.height('100%').backgroundColor('#F1F3F5')
  }

  @Builder DeleteAction(key: number, type: 'student' | 'event_id') {
    Button('åˆ é™¤').type(ButtonType.Normal).backgroundColor('#EF4444').fontColor(Color.White).width(80).height('100%').onClick(() => { 
      animateTo({ duration: 300 }, () => { 
        if (type === 'student') this.students.splice(key, 1); 
        else this.events = this.events.filter(e => e.id !== key);
      }) 
    })
  }

  // --- è¯¦æƒ…é¡µ ---
  @Builder SheetContent() {
    Column() {
      Row() {
        Text(`${this.selectedDate.getMonth() + 1}æœˆ${this.selectedDate.getDate()}æ—¥`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
        Text('æ”¶èµ·').fontSize(14).fontColor('#6B7280').backgroundColor('#F3F4F6').padding({ left: 12, right: 12, top: 6, bottom: 6 }).borderRadius(14).onClick(() => this.isSheetShown = false)
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })

      Row({ space: 12 }) {
        Button() { Row() { Text('ğŸ‘¤').fontSize(16).margin({ right: 8 }); Text('æ’ä¸€èŠ‚è¯¾').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#2563EB') } }
        .backgroundColor('#EFF6FF').type(ButtonType.Normal).borderRadius(16).layoutWeight(1).height(56).shadow({ radius: 5, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        .onClick(() => { this.isSheetShown = false; this.openDialog('class'); })

        Button() { Row() { Text('ğŸ’¡').fontSize(16).margin({ right: 8 }); Text('è®°ä¸ªçµæ„Ÿ').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#F59E0B') } }
        .backgroundColor('#FFF7ED').type(ButtonType.Normal).borderRadius(16).layoutWeight(1).height(56).shadow({ radius: 5, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        .onClick(() => { this.isSheetShown = false; this.openDialog('inspiration'); })
      }.margin({ bottom: 24 })

      List({ space: 12 }) {
        ForEach(this.getGroupedEvents(this.selectedDate), (group: EventGroup) => {
          ListItem() {
            if (group.type === 'class') {
              Column() {
                Row() {
                  Column().width(4).height(40).backgroundColor('#2563EB').borderRadius(2).margin({ right: 12 })
                  Column() {
                    Row() {
                      Text(group.time).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1F2937')
                      if (group.events.every(e => e.status === 'completed')) {
                        Text('å·²å®Œæˆ').fontSize(10).fontColor('#059669').backgroundColor('#D1FAE5').padding({left:8, right:8, top:2, bottom:2}).borderRadius(10)
                      }
                    }.width('100%').justifyContent(FlexAlign.SpaceBetween)
                    Text() {
                      ForEach(group.events, (ev: CalendarEvent, idx: number) => {
                        Span((this.students.find(s => s.id === ev.studentId)?.name || 'æœªçŸ¥') + (idx < group.events.length - 1 ? 'ã€' : '')).fontSize(16).fontColor('#4B5563')
                      })
                    }.margin({ top: 4 })
                  }.layoutWeight(1)
                }.width('100%').alignItems(VerticalAlign.Top)

                Row() {
                  if (!group.events.every(e => e.status === 'completed')) {
                    Button() { Text('æé†’').fontSize(14).fontColor('#2563EB') }
                    .backgroundColor('#EFF6FF').height(32).borderRadius(16).margin({ right: 8 })
                    .onClick(() => {
                       const names = group.events.map(ev => this.students.find(s => s.id === ev.studentId)?.name).join('ã€');
                       NotificationService.startClassReminder(names, group.time);
                    })

                    Button() { Text('å®Œæˆ').fontSize(14).fontColor('#059669') }
                    .backgroundColor('#ECFDF5').height(32).borderRadius(16)
                    .onClick(() => {
                       const eventIdsToUpdate = group.events.map(e => e.id);
                       const studentIdsToUpdate = group.events.map(e => e.studentId);
                       this.events = this.events.map(ev => {
                         if (eventIdsToUpdate.includes(ev.id)) {
                           let newEv = new CalendarEvent(ev.type, ev.date);
                           newEv.id = ev.id; newEv.studentId = ev.studentId; newEv.content = ev.content; newEv.time = ev.time; newEv.status = 'completed';
                           return newEv;
                         }
                         return ev;
                       });
                       this.students = this.students.map(stu => {
                         if (studentIdsToUpdate.includes(stu.id)) {
                           let newStu = new Student(stu.name, stu.totalHours, stu.note, stu.paymentAmount);
                           newStu.id = stu.id; newStu.remainingHours = stu.remainingHours - 1; nstu.paymentDate = stu.paymentDate;
                           return newStu;
                         }
                         return stu;
                       });
                       promptAction.showToast({ message: 'å·²å®Œæˆï¼Œè¯¾æ—¶å·²æ‰£å‡' });
                    })
                  }
                  Blank()
                  Text('ğŸ—‘ï¸').fontSize(16).onClick(() => { this.events = this.events.filter(e => !group.events.some(ge => ge.id === e.id)); })
                }.width('100%').margin({ top: 12 })
              }.padding(16).backgroundColor(Color.White).borderRadius(16).shadow({ radius: 5, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            } else {
              Column() {
                Row() { Column().width(4).height(20).backgroundColor('#FBBF24').borderRadius(2).margin({ right: 12 }); Text('çµæ„Ÿç¬”è®°').fontSize(14).fontColor('#9CA3AF') }.margin({ bottom: 8 })
                Text(group.events[0].content).fontSize(15).fontColor('#4B5563').lineHeight(22)
                Row() { Blank(); Text('ğŸ—‘ï¸').fontSize(16).onClick(() => this.events = this.events.filter(e => e.id !== group.events[0].id)) }.width('100%').margin({ top: 12 })
              }.padding(16).backgroundColor('#FFFBEB').borderRadius(16).shadow({ radius: 5, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            }
          }
        }, (group: EventGroup) => group.id)
      }.width('100%').layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring)
    }.padding(24).width('100%').height('100%').backgroundColor('#F9FAFB').borderRadius({ topLeft: 24, topRight: 24 })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Tabs({ controller: this.tabsController, barPosition: BarPosition.End }) {
        TabContent() { this.CalendarView() } 
        TabContent() { this.StudentsView() } 
      }
      .barHeight(0).scrollable(false).backgroundColor('#F1F3F5') 

      Row() {
        this.CustomTabItem(0, 'æ—¥å†', 'calendar')
        Column().layoutWeight(1).height('100%')
        this.CustomTabItem(1, 'å­¦ç”Ÿ', 'users')
      }
      .width('100%').height(60).backgroundColor(Color.White).shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: -5 })

      Button('+').width(56).height(56).fontSize(32).fontWeight(FontWeight.Lighter).backgroundColor('#2563EB')
        .position({ x: '50%', y: '100%' }).markAnchor({ x: '50%', y: 80 }) 
        .shadow({ radius: 10, color: 'rgba(37, 99, 235, 0.4)', offsetY: 5 })
        .onClick(() => { this.selectedDate = new Date(); this.openDialog('class'); })
    }
    .width('100%').height('100%').backgroundColor('#F1F3F5')
    .bindSheet($$this.isSheetShown, this.SheetContent(), { height: SheetSize.MEDIUM, dragBar: false, backgroundColor: Color.White, showClose: false })
  }

  @Builder CustomTabItem(index: number, name: string, iconType: string) {
    Column() {
      Text(iconType === 'calendar' ? 'ğŸ“…' : 'ğŸ‘¥').fontSize(20).margin({ bottom: 4 }).opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(name).fontColor(this.currentTabIndex === index ? '#2563EB' : '#9CA3AF').fontSize(10).fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
    }.justifyContent(FlexAlign.Center).height('100%').layoutWeight(1)
    .onClick(() => { this.currentTabIndex = index; this.tabsController.changeIndex(index); })
  }
}
