/**
 * è¯¾æ—¶è®° (Class Recorder) - v18.24 æœ€ç»ˆç²¾ç®€ç‰ˆ
 * * æ›´æ–°æ—¥å¿—:
 * 1. [æ¸…ç†] ç§»é™¤äº†æ‰€æœ‰ LazyForEach æµ‹è¯•ä»£ç  (æ•°æ®æºç±»ã€æµ‹è¯•ç»„ä»¶ã€æµ‹è¯•æŒ‰é’®)ï¼Œä»£ç å›å½’æ•´æ´ã€‚
 * 2. [ä¿ç•™] ä¿ç•™äº†ä¹‹å‰æ‰€æœ‰çš„ UI ä¼˜åŒ–(v18.21)ã€äº¤äº’ä¿®å¤(v18.19)å’Œå¿«æ·æ–¹å¼æ”¯æŒ(v18.12)ã€‚
 */

import promptAction from '@ohos.promptAction';
import window from '@ohos.window';
import fs from '@ohos.file.fs';
import picker from '@ohos.file.picker';
import common from '@ohos.app.ability.common';
import { BusinessError } from '@ohos.base';
import curves from '@ohos.curves';

// --- 0. å…¨å±€å·¥å…·å‡½æ•° ---

function formatDate(date: Date): string {
  const y = date.getFullYear();
  const m = (date.getMonth() + 1).toString().padStart(2, '0');
  const d = date.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function getDaysInMonth(date: Date): (Date | null)[] {
  const year = date.getFullYear();
  const month = date.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDayIndex = new Date(year, month, 1).getDay();
  const days: (Date | null)[] = [];
  for (let i = 0; i < firstDayIndex; i++) days.push(null);
  for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
  return days;
}

// --- 1. æ•°æ®æ¨¡å‹ ---

@Observed
class TodoTask {
  id: number;
  content: string;
  isCompleted: boolean;
  createdAt: number;
  dateStr: string;

  constructor(content: string, dateStr: string) {
    this.id = Date.now() + Math.random();
    this.content = content;
    this.isCompleted = false;
    this.createdAt = Date.now();
    this.dateStr = dateStr;
  }
}

class Student {
  id: number = 0;
  name: string = '';
  totalHours: number = 0;
  remainingHours: number = 0;
  paymentDate: string = '';
  note: string = '';
  paymentAmount: number = 0;

  constructor(name: string, totalHours: number, note: string, paymentAmount: number = 0) {
    this.id = Date.now();
    this.name = name;
    this.totalHours = totalHours;
    this.remainingHours = totalHours;
    this.paymentDate = new Date().toISOString().split('T')[0];
    this.note = note;
    this.paymentAmount = paymentAmount;
  }
}

class CalendarEvent {
  id: number = 0;
  date: string = '';
  type: 'class' | 'inspiration' = 'class';
  studentId: number | null = null;
  content: string = '';
  time: string = '';
  status: 'scheduled' | 'completed' = 'scheduled';

  constructor(type: 'class' | 'inspiration', date: string) {
    this.id = Date.now() + Math.random();
    this.type = type;
    this.date = date;
  }
}

class EventGroup {
  id: string;
  time: string;
  type: 'class' | 'inspiration';
  events: CalendarEvent[];

  constructor(time: string, type: 'class' | 'inspiration', events: CalendarEvent[]) {
    this.time = time;
    this.type = type;
    this.events = events;
    this.id = type + '_' + time + '_' + (events.length > 0 ? events[0].id : '0');
  }
}

PersistentStorage.PersistProp('students_data', []);
PersistentStorage.PersistProp('events_data', []);
PersistentStorage.PersistProp('todo_data', []);

// --- 2. ä¸šåŠ¡é€»è¾‘ ---

class DataExporter {
  static async exportStudentData(student: Student, events: CalendarEvent[]) {
    try {
      const studentEvents = events.filter(e => e.studentId === student.id && e.type === 'class');
      let content = '\uFEFF';
      content += `å­¦ç”Ÿæ•°æ®å¯¼å‡ºæŠ¥è¡¨\nç”Ÿæˆæ—¥æœŸ,${new Date().toLocaleDateString()}\n\n`;
      content += `å§“å,${student.name}\næ€»è¯¾æ—¶,${student.totalHours}\nå‰©ä½™,${student.remainingHours}\n\n`;
      content += `æ—¥æœŸ,æ—¶é—´,çŠ¶æ€\n`;
      studentEvents.sort((a, b) => a.date.localeCompare(b.date));
      studentEvents.forEach(ev => {
        const statusStr = ev.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…ä¸Šè¯¾';
        content += `${ev.date},${ev.time},${statusStr}\n`;
      });
      const saveOptions = new picker.DocumentSaveOptions();
      saveOptions.newFileNames = [`${student.name}_è¯¾æ—¶æ•°æ®.csv`];
      const documentViewPicker = new picker.DocumentViewPicker();
      const documentSaveResult = await documentViewPicker.save(saveOptions);
      if (documentSaveResult && documentSaveResult.length > 0) {
        const uri = documentSaveResult[0];
        const file = fs.openSync(uri, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
        fs.writeSync(file.fd, content);
        fs.closeSync(file);
        promptAction.showToast({ message: 'å¯¼å‡ºæˆåŠŸ' });
      }
    } catch (err) {
      console.error('Export failed:', err);
    }
  }
}

// --- 3. æ ·å¼é…ç½® ---

class ColorPalette {
  static readonly background: string = '#F5F7FA';
  static readonly cardBackground: string = '#FFFFFF';
  static readonly primary: string = '#2D6CDF';
  static readonly secondary: string = '#F9A825';
  static readonly accentGreen: string = '#48BB78';
  static readonly textPrimary: ResourceColor = '#1A202C';
  static readonly textSecondary: ResourceColor = '#718096';
  static readonly textDisabled: string = '#CBD5E0';
  static readonly divider: string = '#E2E8F0';
  static readonly success: string = '#48BB78';
  static readonly warning: string = '#F9A825';
  static readonly danger: string = '#E53E3E';
  static readonly shadow: string = 'rgba(45, 108, 223, 0.1)';
  static readonly inputBg: string = '#EDF2F7';
  static readonly classEventBg: string = '#EBF4FF';
  static readonly inspirationEventBg: string = '#F0FFF4';
}

@Builder function IconLeaf(color: ResourceColor, size: number) {
  Stack() { Path().commands('M12 2 C6 2 2 8 2 14 C2 19 6 22 12 22 C18 22 22 19 22 14 C22 8 18 2 12 2 Z M12 22 C12 18 12 14 18 8').fill('none').stroke(color).strokeWidth(2).width(size).height(size) }.width(size).height(size)
}

// --- 4. ç‹¬ç«‹ç»„ä»¶ ---

@Component
struct TodoItem {
  @ObjectLink task: TodoTask;
  @State scaleValue: number = 1.0;
  @State rotateValue: number = 0;

  onDelete: () => void = () => {};
  onToggle: () => void = () => {};

  animateCheckboxToggle(newValue: boolean): void {
    this.onToggle();
    if (newValue) {
      animateTo({ duration: 350, curve: Curve.EaseOut }, () => {
        this.scaleValue = 1.25;
        this.rotateValue = 360;
      });
      setTimeout(() => {
        animateTo({ duration: 300, curve: curves.springMotion(0.4, 0.6) }, () => {
          this.scaleValue = 1.0;
          this.rotateValue = 0;
        });
      }, 200);
    } else {
      animateTo({ duration: 250, curve: Curve.EaseOut }, () => {
        this.scaleValue = 1.0;
        this.rotateValue = 0;
      });
    }
  }

  build() {
    ListItem() {
      Row() {
        Stack({ alignContent: Alignment.Center }) {
          Checkbox({ name: 'task_' + this.task.id })
            .select(this.task.isCompleted)
            .selectedColor(ColorPalette.primary)
            .shape(CheckBoxShape.CIRCLE)
            .width(24).height(24).margin({ right: 4 })
            .scale({ x: this.scaleValue, y: this.scaleValue })
            .rotate({ angle: this.rotateValue, centerX: '50%', centerY: '50%' })
            .hitTestBehavior(HitTestMode.None)
        }
        .width(30).height(30).margin({ right: 4 })

        Text(this.task.content)
          .fontSize(16).fontWeight(FontWeight.Medium)
          .fontColor(this.task.isCompleted ? ColorPalette.textDisabled : ColorPalette.textPrimary)
          .decoration({ type: this.task.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None, color: ColorPalette.textDisabled })
          .maxLines(2).textOverflow({ overflow: TextOverflow.Ellipsis }).layoutWeight(1).margin({ left: 4 })

        Text(this.task.dateStr).fontSize(12).fontColor(ColorPalette.textSecondary).margin({ left: 8, right: 4 })
      }
      .width('100%').padding(16).backgroundColor(ColorPalette.cardBackground).borderRadius(16)
      .shadow({ radius: 8, color: ColorPalette.shadow, offsetY: 2 })
      .onClick(() => { this.animateCheckboxToggle(!this.task.isCompleted); })
    }
    .transition(
      TransitionEffect.OPACITY.animation({ duration: 300 })
        .combine(TransitionEffect.translate({ x: -100 }))
    )
    .swipeAction({ end: this.DeleteButton() })
  }

  @Builder DeleteButton() {
    Row() {
      Button() {
        SymbolGlyph($r('sys.symbol.trash'))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor([Color.White])
      }
      .type(ButtonType.Circle)
      .backgroundColor(ColorPalette.danger)
      .width(56)
      .height(56)
      .shadow({ radius: 8, color: 'rgba(229, 62, 62, 0.4)', offsetY: 2 })
      .onClick(() => {
        animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
          this.onDelete();
        })
      })
    }
    .width(90)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}

@CustomDialog
struct StudentDataDialog {
  controller: CustomDialogController;
  @Link student: Student;
  @Link allEvents: CalendarEvent[];
  build() {
    Column() {
      Row() {
        Text(this.student.name + ' / æ¡£æ¡ˆ').fontSize(22).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
        Text('æ”¶èµ·').fontSize(13).fontColor(ColorPalette.textSecondary).backgroundColor(ColorPalette.inputBg)
          .padding({ left: 14, right: 14, top: 6, bottom: 6 }).borderRadius(14)
          .onClick(() => this.controller.close())
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })
      Scroll() {
        Column({ space: 16 }) {
          Row() {
            Column() {
              Text('æ€»è¯¾æ—¶').fontSize(12).fontColor(ColorPalette.textSecondary).margin({ bottom: 6 })
              Text(`${this.student.totalHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
            Divider().vertical(true).height(30).color(ColorPalette.divider)
            Column() {
              Text('å·²æ¶ˆ').fontSize(12).fontColor(ColorPalette.textSecondary).margin({ bottom: 6 })
              Text(`${this.student.totalHours - this.student.remainingHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ColorPalette.accentGreen)
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
            Divider().vertical(true).height(30).color(ColorPalette.divider)
            Column() {
              Text('å‰©ä½™').fontSize(12).fontColor(ColorPalette.textSecondary).margin({ bottom: 6 })
              Text(`${this.student.remainingHours}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ColorPalette.primary)
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
          }.width('100%').padding(20).backgroundColor(ColorPalette.inputBg).borderRadius(20)

          Row() {
            Text('ç¼´è´¹: ' + this.student.paymentDate).fontSize(13).fontColor(ColorPalette.textSecondary)
            Blank()
            Text('Â¥' + this.student.paymentAmount).fontSize(15).fontColor(ColorPalette.textPrimary).fontWeight(FontWeight.Bold)
          }.width('100%').padding({ left: 8, right: 8 })

          Text('è®°å½•æ˜ç»†').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary).width('100%').margin({ top: 12 })

          List({ space: 10 }) {
            ForEach(this.allEvents.filter(e => e.studentId === this.student.id && e.type === 'class'), (ev: CalendarEvent) => {
              ListItem() {
                Row() {
                  Column() {
                    Text(ev.date).fontSize(14).fontWeight(FontWeight.Medium).fontColor(ColorPalette.textPrimary)
                    Text(ev.time).fontSize(12).fontColor(ColorPalette.textSecondary).margin({ top: 2 })
                  }.alignItems(HorizontalAlign.Start)
                  Blank()
                  if (ev.status === 'completed') {
                    Text('å·²æ¶ˆ').fontSize(11).fontColor(ColorPalette.accentGreen).border({ width: 1, color: ColorPalette.accentGreen }).padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(4)
                  } else {
                    Text('å¾…ä¸Š').fontSize(11).fontColor(ColorPalette.warning).border({ width: 1, color: ColorPalette.warning }).padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(4)
                  }
                }.width('100%').padding(12).backgroundColor(ColorPalette.inputBg).borderRadius(12)
              }
            })
          }.width('100%').height(240)
          Button('å¯¼å‡ºæ•°æ® (CSV)').width('100%').height(50).backgroundColor(ColorPalette.primary).fontColor(Color.White).fontSize(16).fontWeight(FontWeight.Bold).margin({ top: 20 }).borderRadius(25)
            .onClick(() => { DataExporter.exportStudentData(this.student, this.allEvents); })
        }
      }.layoutWeight(1).scrollBar(BarState.Off)
    }.width('100%').height('100%').padding({ left: 24, right: 24, bottom: 32, top: 48 }).backgroundColor(ColorPalette.cardBackground)
  }
}

@CustomDialog
struct AddDialog {
  controller: CustomDialogController;
  type: 'class' | 'inspiration' | 'student_add' = 'class';
  @Link students: Student[];
  @Link events: CalendarEvent[];
  selectedDate: Date = new Date();
  @State nameInput: string = '';
  @State hoursInput: string = '';
  @State noteInput: string = '';
  @State amountInput: string = '';
  @State selectedStudentIds: number[] = [];
  @State timeInput: string = '10:00';
  @State contentInput: string = '';

  build() {
    Column() {
      Text(this.type === 'class' ? 'æ’ä¸€èŠ‚è¯¾' : (this.type === 'inspiration' ? 'è®°å½•çµæ„Ÿ' : 'æ–°å¢å­¦ç”Ÿ')).fontSize(22).fontWeight(FontWeight.Bold).margin({ bottom: 24, top: 8 }).width('100%')
      if (this.type === 'student_add') {
        Column({ space: 14 }) {
          TextInput({ placeholder: 'å­¦ç”Ÿå§“å', text: this.nameInput }).onChange((v)=>this.nameInput=v).backgroundColor(ColorPalette.inputBg).height(50).borderRadius(12).width('100%')
          Row({ space: 12 }) {
            TextInput({ placeholder: 'è´­ä¹°è¯¾æ—¶', text: this.hoursInput }).type(InputType.Number).backgroundColor(ColorPalette.inputBg).borderRadius(12).height(50).layoutWeight(1).onChange((val) => this.hoursInput = val)
            TextInput({ placeholder: 'ç¼´è´¹é‡‘é¢', text: this.amountInput }).type(InputType.Number).backgroundColor(ColorPalette.inputBg).borderRadius(12).height(50).layoutWeight(1).onChange((val) => this.amountInput = val)
          }
          TextInput({ placeholder: 'å¤‡æ³¨ (é€‰å¡«)', text: this.noteInput }).backgroundColor(ColorPalette.inputBg).borderRadius(12).height(50).width('100%').onChange((val) => this.noteInput = val)
        }
      } else if (this.type === 'class') {
        if (this.students.length > 0) {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.students, (s: Student) => {
              Text(s.name).fontSize(14).padding(8).backgroundColor(this.selectedStudentIds.includes(s.id)?ColorPalette.primary:ColorPalette.inputBg).fontColor(this.selectedStudentIds.includes(s.id)?Color.White:ColorPalette.textPrimary).borderRadius(12).margin(4).onClick(()=>{ if(this.selectedStudentIds.includes(s.id)) this.selectedStudentIds=this.selectedStudentIds.filter(id=>id!==s.id); else this.selectedStudentIds.push(s.id); })
            })
          }
        } else { Text('æš‚æ— å­¦ç”Ÿ').fontSize(14).fontColor(ColorPalette.textSecondary) }
        TextInput({ text: this.timeInput }).onChange((v)=>this.timeInput=v).backgroundColor(ColorPalette.inputBg).height(50).borderRadius(12).width('100%').margin({top:10})
      } else {
        TextArea({ placeholder: 'æƒ³æ³•...' }).onChange((v)=>this.contentInput=v).height(100).backgroundColor(ColorPalette.inputBg).borderRadius(12).width('100%')
      }
      Row({ space: 16 }) {
        Button('å–æ¶ˆ').layoutWeight(1).onClick(() => this.controller.close()).backgroundColor(ColorPalette.inputBg).fontColor(ColorPalette.textSecondary)
        Button('ç¡®è®¤').layoutWeight(1).onClick(() => this.handleSubmit()).backgroundColor(ColorPalette.primary)
      }.margin({ top: 24 }).width('100%')
    }.padding(24).backgroundColor(ColorPalette.cardBackground).borderRadius(24).width('85%')
  }

  handleSubmit(): void {
    const dateStr = formatDate(this.selectedDate);

    if (this.type === 'class') {
      this.selectedStudentIds.forEach(id => {
        let evt = new CalendarEvent('class', dateStr);
        evt.studentId = id;
        evt.time = this.timeInput;
        this.events.push(evt);
      });
    } else if (this.type === 'student_add') {
      this.students.push(new Student(this.nameInput, parseInt(this.hoursInput)||0, this.noteInput, parseInt(this.amountInput)||0));
    } else {
      let evt = new CalendarEvent('inspiration', dateStr);
      evt.content = this.contentInput;
      this.events.push(evt);
    }
    this.controller.close();
  }
}

// --- 5. ä¸»åº”ç”¨å…¥å£ ---

@Entry
@Component
struct ClassRecorderApp {
  @StorageLink('students_data') students: Student[] = [];
  @StorageLink('events_data') events: CalendarEvent[] = [];
  @StorageLink('todo_data') todoTasks: TodoTask[] = [];

  @State currentTabIndex: number = 0;
  private tabsController: TabsController = new TabsController();

  @State currentDate: Date = new Date();
  @State selectedDate: Date = new Date();
  @State isSheetShown: boolean = false;

  @State sheetType: 'events' | 'todo' = 'events';

  @State dialogType: 'class' | 'inspiration' | 'student_add' = 'class';
  @State currentViewingStudent: Student = new Student('', 0, '');
  @State currentViewingEvents: CalendarEvent[] = [];
  @State newTodoContent: string = '';

  @State calendarCardTrigger: number = 0;
  @State todoCardTrigger: number = 0;

  studentDataDialogController: CustomDialogController = new CustomDialogController({
    builder: StudentDataDialog({ student: $currentViewingStudent, allEvents: $currentViewingEvents }),
    alignment: DialogAlignment.Center, customStyle: true, autoCancel: true
  });

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddDialog({ type: this.dialogType, students: $students, events: $events, selectedDate: this.selectedDate }),
    alignment: DialogAlignment.Center, customStyle: true, autoCancel: true
  });

  setStatusBar(): void {
    try {
      window.getLastWindow(getContext(this)).then((win) => {
        win.setWindowLayoutFullScreen(true);
        win.setWindowSystemBarProperties({ statusBarColor: '#00FFFFFF', statusBarContentColor: '#000000', navigationBarColor: ColorPalette.background, navigationBarContentColor: '#000000' })
      })
    } catch (err) {}
  }

  handleShortcutAction(): void {
    const action = AppStorage.Get<string>('shortcutAction');
    if (action) {
      this.selectedDate = new Date();
      this.currentDate = new Date();

      if (action === 'open_class') {
        setTimeout(() => { this.openDialog('class'); }, 100);
      } else if (action === 'open_inspiration') {
        setTimeout(() => { this.openDialog('inspiration'); }, 100);
      } else if (action === 'open_todo') {
        this.sheetType = 'todo';
        setTimeout(() => { this.isSheetShown = true; }, 100);
      }

      AppStorage.SetOrCreate('shortcutAction', '');
    }
  }

  aboutToAppear(): void {
    this.setStatusBar();
    this.handleShortcutAction();
  }

  onPageShow(): void {
    this.setStatusBar();
    this.handleShortcutAction();
  }

  openDialog(type: 'class' | 'inspiration' | 'student_add'): void {
    this.dialogType = type;
    this.dialogController.open();
  }

  openStudentData(index: number): void {
    this.currentViewingStudent = this.students[index];
    this.currentViewingEvents = this.events;
    this.studentDataDialogController.open();
  }

  getIncompleteTasks(selectedDateStr: string): TodoTask[] {
    return this.todoTasks.filter(t => t.dateStr === selectedDateStr && !t.isCompleted).sort((a, b) => b.createdAt - a.createdAt);
  }

  getCompletedTasks(selectedDateStr: string): TodoTask[] {
    return this.todoTasks.filter(t => t.dateStr === selectedDateStr && t.isCompleted).sort((a, b) => b.createdAt - a.createdAt);
  }

  addTodo(): void {
    if (!this.newTodoContent.trim()) { promptAction.showToast({ message: 'è¯·è¾“å…¥ä»»åŠ¡å†…å®¹' }); return; }
    animateTo({ duration: 300 }, () => {
      this.todoTasks.unshift(new TodoTask(this.newTodoContent.trim(), formatDate(this.selectedDate)));
      this.newTodoContent = '';
    })
  }

  deleteTask(id: number): void {
    animateTo({ duration: 300 }, () => { this.todoTasks = this.todoTasks.filter(t => t.id !== id); })
  }

  toggleTask(id: number): void {
    animateTo({ duration: 350, curve: Curve.EaseOut }, () => {
      const index = this.todoTasks.findIndex(t => t.id === id);
      if (index !== -1) {
        let newTask = new TodoTask(this.todoTasks[index].content, this.todoTasks[index].dateStr);
        newTask.id = this.todoTasks[index].id; newTask.createdAt = this.todoTasks[index].createdAt; newTask.isCompleted = !this.todoTasks[index].isCompleted;
        this.todoTasks[index] = newTask; this.todoTasks = [...this.todoTasks];
      }
    })
  }

  calculateProgress(): number {
    const selectedDateStr = formatDate(this.selectedDate);
    const currentDayTasks = this.todoTasks.filter(t => t.dateStr === selectedDateStr);
    if (currentDayTasks.length === 0) return 0;
    const completed = currentDayTasks.filter(t => t.isCompleted).length;
    return Math.round((completed / currentDayTasks.length) * 100);
  }

  getEventsForDay(date: Date | null): CalendarEvent[] {
    if (!date) return [];
    return this.events.filter(e => e.date === formatDate(date));
  }

  getGroupedEvents(date: Date): EventGroup[] {
    const rawEvents = this.getEventsForDay(date);
    const groups: EventGroup[] = [];
    const classEvents = rawEvents.filter(e => e.type === 'class');
    const inspirationEvents = rawEvents.filter(e => e.type === 'inspiration');
    const timeMap = new Map<string, CalendarEvent[]>();
    classEvents.forEach(ev => { if (!timeMap.has(ev.time)) { timeMap.set(ev.time, []); } timeMap.get(ev.time)?.push(ev); });
    timeMap.forEach((events, time) => { groups.push(new EventGroup(time, 'class', events)); });
    inspirationEvents.forEach(ev => { groups.push(new EventGroup(ev.time || 'å…¨å¤©', 'inspiration', [ev])); });

    return groups.sort((a, b) => {
      if (a.type !== b.type) {
        return a.type === 'class' ? -1 : 1;
      }
      return a.time.localeCompare(b.time);
    });
  }

  // --- ä¾§æ»‘èœå•æ„å»ºå™¨ ---

  @Builder DeleteSwipeAction(callback: () => void) {
    Row() {
      Button() {
        SymbolGlyph($r('sys.symbol.trash'))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor([Color.White])
      }
      .type(ButtonType.Circle)
      .backgroundColor(ColorPalette.danger)
      .width(56)
      .height(56)
      .shadow({ radius: 8, color: 'rgba(229, 62, 62, 0.4)', offsetY: 2 })
      .onClick(() => {
        animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
          callback();
        })
      })
    }
    .width(90)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder CompleteSwipeAction(callback: () => void) {
    Row() {
      Button() {
        SymbolGlyph($r('sys.symbol.checkmark'))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor([Color.White])
      }
      .type(ButtonType.Circle)
      .backgroundColor(ColorPalette.accentGreen)
      .width(56)
      .height(56)
      .shadow({ radius: 8, color: 'rgba(72, 187, 120, 0.4)', offsetY: 2 })
      .onClick(() => {
        callback();
      })
    }
    .width(90)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder DeleteAction(key: number, type: 'student' | 'event_id') {
    this.DeleteSwipeAction(() => {
      if (type === 'student') this.students.splice(key, 1);
      else this.events = this.events.filter(e => e.id !== key);
    })
  }

  @Builder CustomTabItem(index: number, name: string, symbol: Resource) {
    Column() {
      SymbolGlyph(symbol).fontSize(24).fontColor([this.currentTabIndex === index ? ColorPalette.primary : ColorPalette.textSecondary]).margin({ bottom: 4 })
        .symbolEffect(new BounceSymbolEffect(EffectScope.WHOLE, EffectDirection.UP), this.currentTabIndex === index)
      Text(name).fontColor(this.currentTabIndex === index ? ColorPalette.primary : ColorPalette.textSecondary).fontSize(11).fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
    }.justifyContent(FlexAlign.Center).height('100%').layoutWeight(1).onClick(() => { this.currentTabIndex = index; this.tabsController.changeIndex(index); })
  }

  @Builder CalendarView() {
    Stack() {
      Stack() { IconLeaf(ColorPalette.primary, 120) }.position({ x: -30, y: 40 }).opacity(0.1).rotate({ angle: -30 })
      Stack() { IconLeaf(ColorPalette.accentGreen, 150) }.position({ x: '80%', y: '70%' }).opacity(0.05).rotate({ angle: 45 })
      Column() {
        Row() { Text('è¯¾æ—¶è®°').fontSize(30).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary).letterSpacing(2) }.width('100%').justifyContent(FlexAlign.Center).padding({ top: 48, bottom: 10 })
        Scroll() {
          Column() {
            Column() {
              Row() {
                Button() { Text('<').fontSize(20).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textSecondary) }.type(ButtonType.Circle).backgroundColor(ColorPalette.inputBg).width(40).height(40)
                .onClick(() => { let d = new Date(this.currentDate); d.setMonth(d.getMonth() - 1); this.currentDate = d; })
                Column() {
                  Text(`${this.currentDate.getMonth() + 1}æœˆ`).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
                  Text(`${this.currentDate.getFullYear()}`).fontSize(16).fontColor(ColorPalette.textSecondary).letterSpacing(1)
                }.margin({ left: 24, right: 24 }).onClick(() => { DatePickerDialog.show({ start: new Date("2020-1-1"), end: new Date("2100-12-31"), selected: this.currentDate, onAccept: (value: DatePickerResult) => { this.currentDate = new Date(value.year!, value.month!, 1); } }) })
                Button() { Text('>').fontSize(20).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textSecondary) }.type(ButtonType.Circle).backgroundColor(ColorPalette.inputBg).width(40).height(40)
                .onClick(() => { let d = new Date(this.currentDate); d.setMonth(d.getMonth() + 1); this.currentDate = d; })
              }.width('100%').justifyContent(FlexAlign.Center).margin({ top: 16, bottom: 24 })

              Flex({ justifyContent: FlexAlign.SpaceAround }) { ForEach(['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'], (day: string) => { Text(day).fontSize(14).fontColor(ColorPalette.textSecondary).fontWeight(FontWeight.Medium) }) }.padding({ left: 12, right: 12 }).margin({ bottom: 12 })

              Grid() {
                ForEach(getDaysInMonth(this.currentDate), (date: Date | null) => {
                  GridItem() {
                    if (date) {
                      Column() {
                        Text(`${date.getDate()}`).fontSize(18).fontWeight(FontWeight.Medium)
                          .fontColor(formatDate(date) === formatDate(new Date()) ? Color.White : (formatDate(date) === formatDate(this.selectedDate) ? ColorPalette.textPrimary : ColorPalette.textPrimary))
                          .width(42).height(42).textAlign(TextAlign.Center).borderRadius(21)
                          .backgroundColor(formatDate(date) === formatDate(new Date()) ? ColorPalette.primary : (formatDate(date) === formatDate(this.selectedDate) ? ColorPalette.inputBg : Color.Transparent))
                          .shadow({ radius: formatDate(date) === formatDate(new Date()) ? 8 : 0, color: ColorPalette.shadow, offsetY: 3 })
                        Row({ space: 4 }) {
                          if (this.getEventsForDay(date).some(e => e.type === 'class')) Circle({ width: 5, height: 5 }).fill(ColorPalette.primary)
                          if (this.getEventsForDay(date).some(e => e.type === 'inspiration')) Circle({ width: 5, height: 5 }).fill(ColorPalette.secondary)
                        }.margin({ top: 6 })
                      }
                      .height(68).width('100%').justifyContent(FlexAlign.Start)
                      .backgroundColor(Color.Transparent)
                      .onClick(() => {
                        if (this.isSheetShown && formatDate(this.selectedDate) === formatDate(date)) {
                          return;
                        }
                        this.selectedDate = date;
                        this.sheetType = 'events';
                        setTimeout(() => {
                          this.isSheetShown = true;
                        }, 10);
                      })
                    }
                  }
                })
              }.columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr').rowsGap(8).padding({ left: 12, right: 12 }).height(350)
            }.width('90%').backgroundColor(ColorPalette.cardBackground).borderRadius(32).padding({ top: 24, bottom: 16 }).margin({ top: 10 }).shadow({ radius: 30, color: ColorPalette.shadow, offsetY: 10 })

            Column() {
              Row() {
                Column() {
                  Text('ä»Šæ—¥æ¦‚è§ˆ').fontSize(22).fontColor(ColorPalette.primary).fontWeight(FontWeight.Bold).margin({ bottom: 4 })
                  Text(`${this.getEventsForDay(new Date()).length} é¡¹æ—¥ç¨‹`).fontSize(14).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
                }.alignItems(HorizontalAlign.Start)
                SymbolGlyph($r('sys.symbol.calendar')).fontSize(40).fontColor([ColorPalette.primary])
                  .symbolEffect(new BounceSymbolEffect(EffectScope.WHOLE, EffectDirection.DOWN), this.calendarCardTrigger)
              }.width('100%').justifyContent(FlexAlign.SpaceBetween)
              .onClick(() => {
                this.calendarCardTrigger++;
                this.selectedDate = new Date();
                this.sheetType = 'events';
                setTimeout(() => { this.isSheetShown = true; }, 10);
              })
            }.width('90%').backgroundColor(ColorPalette.cardBackground).borderRadius(24).padding(24).margin({ top: 20 }).shadow({ radius: 24, color: ColorPalette.shadow, offsetY: 8 })

            Column() {
              Row() {
                Column() {
                  Text('ä»Šæ—¥å¾…åŠ').fontSize(22).fontColor(ColorPalette.primary).fontWeight(FontWeight.Bold).margin({ bottom: 4 })
                  Text(`${this.todoTasks.filter(t => t.dateStr === formatDate(new Date()) && !t.isCompleted).length} ä¸ªæœªå®Œæˆ`).fontSize(14).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
                }.alignItems(HorizontalAlign.Start)
                SymbolGlyph($r('sys.symbol.doc_plaintext')).fontSize(40).fontColor([ColorPalette.primary])
                  .symbolEffect(new BounceSymbolEffect(EffectScope.WHOLE, EffectDirection.DOWN), this.todoCardTrigger)
              }.width('100%').justifyContent(FlexAlign.SpaceBetween)
              .onClick(() => {
                this.todoCardTrigger++;
                this.selectedDate = new Date();
                this.sheetType = 'todo';
                setTimeout(() => { this.isSheetShown = true; }, 10);
              })
            }.width('90%').backgroundColor(ColorPalette.cardBackground).borderRadius(24).padding(24).margin({ top: 16 }).shadow({ radius: 24, color: ColorPalette.shadow, offsetY: 8 })

          }.padding({ bottom: 160 })
        }.scrollBar(BarState.Off).layoutWeight(1).edgeEffect(EdgeEffect.Spring)
      }
    }.width('100%').height('100%').backgroundColor(ColorPalette.background)
  }

  @Builder SheetContent() {
    Column() {
      Row() {
        Row() {
          Text(`${this.selectedDate.getMonth() + 1}æœˆ${this.selectedDate.getDate()}æ—¥`).fontSize(26).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
          Text(this.sheetType === 'todo' ? ' / å¾…åŠæ¸…å•' : ' / æ—¥ç¨‹æ¦‚è§ˆ').fontSize(16).fontColor(ColorPalette.textSecondary).margin({left: 8, top: 8})
        }
        Text('æ”¶èµ·').fontSize(13).fontColor(Color.White).backgroundColor(ColorPalette.primary).padding({ left: 14, right: 14, top: 8, bottom: 8 }).borderRadius(20).onClick(() => this.isSheetShown = false)
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 24 })

      if (this.sheetType === 'events') {
        Row({ space: 16 }) {
          Button() { Row() { SymbolGlyph($r('sys.symbol.calendar')).fontSize(24).fontColor([ColorPalette.primary]); Text(' æ’ä¸€èŠ‚è¯¾').fontSize(17).fontWeight(FontWeight.Bold).fontColor(ColorPalette.primary).margin({ left: 8 }) } }
          .backgroundColor(ColorPalette.classEventBg).type(ButtonType.Normal).borderRadius(24).layoutWeight(1).height(64).shadow({ radius: 8, color: ColorPalette.shadow, offsetY: 3 })
          .onClick(() => { this.isSheetShown = false; this.openDialog('class'); })
          Button() { Row() { SymbolGlyph($r('sys.symbol.lightbulb')).fontSize(24).fontColor([ColorPalette.secondary]); Text(' è®°ä¸ªçµæ„Ÿ').fontSize(17).fontWeight(FontWeight.Bold).fontColor(ColorPalette.secondary).margin({ left: 8 }) } }
          .backgroundColor(ColorPalette.inspirationEventBg).type(ButtonType.Normal).borderRadius(24).layoutWeight(1).height(64).shadow({ radius: 8, color: ColorPalette.shadow, offsetY: 3 })
          .onClick(() => { this.isSheetShown = false; this.openDialog('inspiration'); })
        }.margin({ bottom: 28 })

        List({ space: 16 }) {
          ForEach(this.getGroupedEvents(this.selectedDate), (group: EventGroup) => {
            ListItem() {
              if (group.type === 'class') {
                Column() {
                  Row() {
                    Column().width(6).height(24).backgroundColor(ColorPalette.primary).borderRadius(3).margin({ right: 12 })
                    Text('è¯¾ç¨‹ä¿¡æ¯').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textSecondary)
                    Blank()
                    Column().width(6).height(24).backgroundColor(ColorPalette.primary).borderRadius(3).margin({ right: 3 })
                    Text(group.time).fontSize(16).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary).margin({ left: 12 })
                    Blank()
                    if (group.events.every(e => e.status === 'completed')) {
                      Text('å·²å®Œæˆ').fontSize(12).fontColor(Color.White).backgroundColor(ColorPalette.primary).padding({left:8, right:8, top:4, bottom:4}).borderRadius(10)
                    }
                  }.width('100%').alignItems(VerticalAlign.Center).margin({ bottom: 12 })

                  Text() {
                    ForEach(group.events, (ev: CalendarEvent, idx: number) => {
                      Span((this.students.find(s => s.id === ev.studentId)?.name || 'æœªçŸ¥') + (idx < group.events.length - 1 ? 'ã€' : '')).fontSize(16).fontColor(ColorPalette.textSecondary)
                    })
                  }.fontSize(16).lineHeight(24).width('100%')
                }.width('100%').padding(16).backgroundColor(group.events.every(e => e.status === 'completed') ? ColorPalette.classEventBg : ColorPalette.cardBackground).borderRadius(24).shadow({ radius: 8, color: 'rgba(0,0,0,0.03)', offsetY: 3 })
              } else {
                Column() {
                  Row() {
                    Column().width(6).height(24).backgroundColor(ColorPalette.secondary).borderRadius(3).margin({ right: 12 });
                    Text('çµæ„Ÿç¬”è®°').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textSecondary)
                  }.margin({ bottom: 8 })
                  Text(group.events[0].content).fontSize(16).fontColor(ColorPalette.textPrimary).lineHeight(26)
                }.width('100%').padding(16).height(100).backgroundColor(ColorPalette.inspirationEventBg).borderRadius(24).shadow({ radius: 8, color: 'rgba(0,0,0,0.03)', offsetY: 3 }).alignItems(HorizontalAlign.Start)
              }
            }
            .transition(
              TransitionEffect.OPACITY.animation({ duration: 300 })
                .combine(TransitionEffect.translate({ x: -100 }))
            )
            .swipeAction({
              start: group.type === 'class' && !group.events.every(e => e.status === 'completed') ? {
                builder: () => { this.CompleteSwipeAction(() => {
                  const eventIds = group.events.map(e => e.id);
                  const studentIds = group.events.map(e => e.studentId);
                  this.events = this.events.map(ev => { if (eventIds.includes(ev.id)) { let nev = new CalendarEvent(ev.type, ev.date); nev.id = ev.id; nev.studentId = ev.studentId; nev.content = ev.content; nev.time = ev.time; nev.status = 'completed'; return nev; } return ev; });
                  this.students = this.students.map(stu => { if (studentIds.includes(stu.id)) { let nstu = new Student(stu.name, stu.totalHours, stu.note, stu.paymentAmount); nstu.id = stu.id; nstu.remainingHours = stu.remainingHours - 1; nstu.paymentDate = stu.paymentDate; return nstu; } return stu; });
                  promptAction.showToast({ message: 'å·²å®Œæˆï¼Œè¯¾æ—¶å·²æ‰£å‡' });
                })}
              } : undefined,
              end: {
                builder: () => { this.DeleteSwipeAction(() => {
                  this.events = this.events.filter(e => !group.events.some(ge => ge.id === e.id));
                })}
              }
            })
          }, (group: EventGroup) => group.id)
        }.width('100%').layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring)

      } else {
        List({ space: 12 }) {
          ForEach(this.getIncompleteTasks(formatDate(this.selectedDate)), (task: TodoTask) => {
            TodoItem({ task: task, onDelete: () => this.deleteTask(task.id), onToggle: () => this.toggleTask(task.id) })
          }, (item: TodoTask) => item.id.toString())

          if (this.getCompletedTasks(formatDate(this.selectedDate)).length > 0) {
            ListItem() { Text('å·²å®Œæˆ').fontSize(14).fontColor(ColorPalette.textSecondary).fontWeight(FontWeight.Bold).margin({ top: 16, bottom: 8 }) }
            ForEach(this.getCompletedTasks(formatDate(this.selectedDate)), (task: TodoTask) => {
              TodoItem({ task: task, onDelete: () => this.deleteTask(task.id), onToggle: () => this.toggleTask(task.id) })
            }, (item: TodoTask) => item.id.toString())
          }

          if (this.getIncompleteTasks(formatDate(this.selectedDate)).length === 0 && this.getCompletedTasks(formatDate(this.selectedDate)).length === 0) {
            ListItem() { Text('ğŸ‰ ä»Šæ—¥æ— å¾…åŠ').fontSize(16).fontColor(ColorPalette.textSecondary).width('100%').textAlign(TextAlign.Center).padding(30) }
          }
        }.width('100%').layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring)

        Row({ space: 12 }) {
          TextInput({ placeholder: 'æ·»åŠ æ–°ä»»åŠ¡...', text: this.newTodoContent }).layoutWeight(1).height(46).backgroundColor(ColorPalette.inputBg).borderRadius(23).placeholderColor(ColorPalette.textSecondary).padding({left: 16, right: 16}).onChange((val) => this.newTodoContent = val).onSubmit(() => this.addTodo())

          Button({type: ButtonType.Circle}) {
            SymbolGlyph($r('sys.symbol.arrow_up'))
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor([Color.White])
          }
          .width(46).height(46)
          .backgroundColor(ColorPalette.primary)
          .onClick(() => this.addTodo())
        }.width('100%').margin({ top: 16, bottom: 8 })
      }
    }.padding(28).width('100%').height('100%').backgroundColor(ColorPalette.cardBackground).borderRadius({ topLeft: 32, topRight: 32 })
  }

  @Builder StudentsView() {
    Stack() {
      Column().width('100%').height('100%').backgroundColor(ColorPalette.background)
      Column() {
        Row() {
          Text('å­¦ç”Ÿç®¡ç†').fontSize(28).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
          Button('+ æ–°å¢').height(40).fontSize(15).fontWeight(FontWeight.Bold).backgroundColor(ColorPalette.primary).borderRadius(20)
            .shadow({ radius: 8, color: ColorPalette.shadow, offsetY: 4 }).onClick(() => this.openDialog('student_add'))
        }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ left: 24, right: 24, top: 56, bottom: 24 })
        List({ space: 16 }) {
          ForEach(this.students, (student: Student, index: number) => {
            ListItem() {
              Row() {
                Stack({ alignContent: Alignment.Center }) { Circle().width(56).height(56).fill(ColorPalette.inputBg); Text(student.name.substring(0, 1)).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ColorPalette.primary) }.margin({ right: 16 })
                Column() { Row() { Text(student.name).fontSize(18).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary); if (student.remainingHours <= 3) Text('ä½™é¢ä¸è¶³').fontSize(11).fontColor(Color.White).backgroundColor(ColorPalette.danger).padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(8).margin({ left: 8 }) }; Text(student.note || 'æ— å¤‡æ³¨').fontSize(14).fontColor(ColorPalette.textSecondary).margin({ top: 4 }) }.alignItems(HorizontalAlign.Start).layoutWeight(1)
                Column() { Text('å‰©ä½™').fontSize(12).fontColor(ColorPalette.textSecondary); Text() { Span(`${student.remainingHours}`).fontSize(22).fontWeight(FontWeight.Bold).fontColor(student.remainingHours <= 3 ? ColorPalette.danger : ColorPalette.primary); Span(` / ${student.totalHours}`).fontSize(14).fontColor(ColorPalette.textSecondary) } }
              }.padding(20).width('100%').backgroundColor(ColorPalette.cardBackground).borderRadius(24).shadow({ radius: 10, color: ColorPalette.shadow, offsetY: 4 }).onClick(() => { this.openStudentData(index); })
            }.swipeAction({ end: this.DeleteAction(index, 'student') })
          })
        }.width('100%').padding({ left: 20, right: 20, bottom: 120 }).layoutWeight(1).edgeEffect(EdgeEffect.Spring)
      }
    }
  }

  @Builder TodoListView() {
    Column() {
      Row({ space: 24 }) {
        Column() {
          Row() {
            Text('å¾…åŠæ¸…å•').fontSize(28).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary)
            SymbolGlyph($r('sys.symbol.calendar')).fontSize(24).fontColor([ColorPalette.primary]).margin({ left: 8 })
              .onClick(() => { DatePickerDialog.show({ start: new Date("2020-1-1"), end: new Date("2100-12-31"), selected: this.selectedDate, onDateAccept: (value: Date) => { this.selectedDate = new Date(value.getFullYear(), value.getMonth(), value.getDate()); } }) })
          }.width('100%').alignItems(VerticalAlign.Center)
          Text(`${this.getIncompleteTasks(formatDate(this.selectedDate)).length} ä¸ªæœªå®Œæˆ | ${formatDate(this.selectedDate)}`).fontSize(14).fontColor(ColorPalette.textSecondary).margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start).layoutWeight(1)
        Stack({ alignContent: Alignment.Center }) { Progress({ value: this.calculateProgress(), total: 100, type: ProgressType.Ring }).color(ColorPalette.primary).backgroundColor(ColorPalette.inputBg).style({ strokeWidth: 8 }).width(60).height(60); Text(`${this.calculateProgress()}%`).fontSize(14).fontWeight(FontWeight.Bold).fontColor(ColorPalette.textPrimary) }
      }.width('100%').alignItems(VerticalAlign.Center).justifyContent(FlexAlign.SpaceBetween).padding({ left: 24, right: 24, top: 56, bottom: 24 })

      List({ space: 12 }) {
        ForEach(this.getIncompleteTasks(formatDate(this.selectedDate)), (task: TodoTask) => {
          TodoItem({ task: task, onDelete: () => { this.deleteTask(task.id); }, onToggle: () => { this.toggleTask(task.id); } })
        }, (item: TodoTask) => item.id.toString())

        if (this.getCompletedTasks(formatDate(this.selectedDate)).length > 0) {
          ListItem() { Text('å·²å®Œæˆ').fontSize(14).fontColor(ColorPalette.textSecondary).fontWeight(FontWeight.Bold).margin({ top: 16, bottom: 8 }) }
          ForEach(this.getCompletedTasks(formatDate(this.selectedDate)), (task: TodoTask) => {
            TodoItem({ task: task, onDelete: () => { this.deleteTask(task.id); }, onToggle: () => { this.toggleTask(task.id); } })
          }, (item: TodoTask) => item.id.toString())
        }
        if (this.getIncompleteTasks(formatDate(this.selectedDate)).length === 0 && this.getCompletedTasks(formatDate(this.selectedDate)).length === 0) { ListItem() { Text(`ğŸ‰ æ— å¾…åŠäº‹é¡¹`).fontSize(16).fontColor(ColorPalette.textSecondary).width('100%').textAlign(TextAlign.Center).padding(20) } }
      }.width('100%').layoutWeight(1).padding({ left: 20, right: 20, bottom: 20 }).edgeEffect(EdgeEffect.Spring).divider({ strokeWidth: 0 })

      Row({ space: 12 }) {
        TextInput({ placeholder: 'æ·»åŠ æ–°ä»»åŠ¡...', text: this.newTodoContent }).layoutWeight(1).height(50).backgroundColor(ColorPalette.cardBackground).borderRadius(12).fontColor(ColorPalette.textPrimary).placeholderColor(ColorPalette.textSecondary).padding({ left: 20, right: 20 }).shadow({ radius: 10, color: ColorPalette.shadow, offsetY: 4 }).enterKeyType(EnterKeyType.Done).onChange((val) => this.newTodoContent = val).onSubmit(() => this.addTodo())

        Button({ type: ButtonType.Circle }) {
          SymbolGlyph($r('sys.symbol.arrow_up'))
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor([Color.White])
        }
        .width(50).height(50)
        .backgroundColor(ColorPalette.primary)
        .shadow({ radius: 10, color: ColorPalette.shadow, offsetY: 4 })
        .onClick(() => this.addTodo())

      }.width('100%').padding({ left: 20, right: 20, bottom: 100 }).backgroundColor('transparent')
    }.width('100%').height('100%').backgroundColor(ColorPalette.background)
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Tabs({ controller: this.tabsController, barPosition: BarPosition.End }) {
        TabContent() { this.CalendarView() }
        TabContent() { this.StudentsView() }
        TabContent() { this.TodoListView() }
      }.barHeight(0).scrollable(false).backgroundColor(ColorPalette.background)
      Row() {
        this.CustomTabItem(0, 'æ—¥å†', $r('sys.symbol.calendar'))
        this.CustomTabItem(1, 'å­¦ç”Ÿ', $r('sys.symbol.person_2'))
        this.CustomTabItem(2, 'å¾…åŠ', $r('sys.symbol.doc_plaintext'))
      }.width('100%').height(80).backgroundColor(ColorPalette.cardBackground).padding({ bottom: 16 }).justifyContent(FlexAlign.SpaceAround).shadow({ radius: 16, color: 'rgba(0,0,0,0.05)', offsetY: -4 })
    }.width('100%').height('100%').backgroundColor(ColorPalette.background).bindSheet($$this.isSheetShown, this.SheetContent(), { height: SheetSize.MEDIUM, dragBar: false, backgroundColor: ColorPalette.cardBackground, showClose: false })
  }
}
