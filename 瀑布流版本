/**
 * ËØæÊó∂ËÆ∞ (Class Recorder) - ÂçïÂàóÂç°ÁâáÁâà
 * * ‰øÆÊîπÊó•ÂøóÔºö
 * 1. Â∏ÉÂ±ÄÈáçÊûÑÔºöËØ¶ÊÉÖÈ°µ (SheetContent) Â∞ÜÂèåÂàó WaterFlow Êîπ‰∏∫ÂçïÂàó ListÔºå‰ø°ÊÅØÂ±ïÁ§∫Êõ¥Ê∏ÖÊô∞„ÄÇ
 * 2. UI ÂçáÁ∫ßÔºö
 * - Êìç‰ΩúÊåâÈíÆÔºöÂ∫ïÈÉ®ÁöÑ‚ÄúÊèêÈÜí‚ÄùÂíå‚ÄúÂÆåÊàê‚ÄùÊîπ‰∏∫ÊñáÂ≠ó+Ëâ≤ÂùóÁöÑËÉ∂ÂõäÊåâÈíÆÊ†∑ÂºèÔºåËßÜËßâÊõ¥Á™ÅÂá∫„ÄÇ
 * - ÂàóË°®Èó¥Ë∑ùÔºöÂç°Áâá‰πãÈó¥Â¢ûÂä† 12vp Èó¥Ë∑ùÔºå‰øùÊåÅÂëºÂê∏ÊÑü„ÄÇ
 * 3. ËßÜËßâ‰ºòÂåñÔºö‰øùÁïô‰∫ÜÊüîÂíåÁöÑËé´ÂÖ∞Ëø™Ëâ≤Á≥ªÂíåÂç°ÁâáÈò¥ÂΩ±„ÄÇ
 * 4. Ê†∏ÂøÉÈÄªËæë‰øùÊåÅÔºöÂ§öÈÄâÊéíËØæ„ÄÅÊâ£ËØæÈÄªËæë„ÄÅÁä∂ÊÄÅÊ†èÊ≤âÊµ∏ÂºèÂùá‰øùÁïô„ÄÇ
 */

import promptAction from '@ohos.promptAction';
import notificationManager from '@ohos.notificationManager';
import notification from '@ohos.notification'; 
import window from '@ohos.window'; 

// --- 1. Êï∞ÊçÆÊ®°ÂûãÂÆö‰πâ ---
class Student {
  id: number = 0;
  name: string = '';
  totalHours: number = 0;
  remainingHours: number = 0;
  paymentDate: string = '';
  note: string = '';

  constructor(name: string, totalHours: number, note: string) {
    this.id = Date.now();
    this.name = name;
    this.totalHours = totalHours;
    this.remainingHours = totalHours;
    this.paymentDate = new Date().toISOString().split('T')[0];
    this.note = note;
  }
}

class CalendarEvent {
  id: number = 0;
  date: string = '';
  type: 'class' | 'inspiration' = 'class';
  studentId: number | null = null;
  content: string = '';
  time: string = '';
  status: 'scheduled' | 'completed' = 'scheduled';

  constructor(type: 'class' | 'inspiration', date: string) {
    this.id = Date.now() + Math.random(); 
    this.type = type;
    this.date = date;
  }
}

// ÂàùÂßãÂåñÊåÅ‰πÖÂåñÊï∞ÊçÆ
PersistentStorage.PersistProp('students_data', []);
PersistentStorage.PersistProp('events_data', []);

// --- 2. ‰∏öÂä°ÈÄªËæëÔºöÈÄöÁü•ÊúçÂä° ---
class NotificationService {
  static readonly NOTIFICATION_ID = 1001;

  static async startClassReminder(studentName: string, time: string) {
    try {
      await notificationManager.requestEnableNotification();
      let notificationRequest: notificationManager.NotificationRequest = {
        id: NotificationService.NOTIFICATION_ID,
        slotType: notification.SlotType.SOCIAL_COMMUNICATION, 
        content: {
          contentType: notification.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: `Âç≥Â∞Ü‰∏äËØæÔºö${studentName}`,
            text: `Êó∂Èó¥Ôºö${time} | ËØ∑ÂÅöÂ•Ω‰∏äËØæÂáÜÂ§á`,
            additionalText: "ËØæÊó∂ËÆ∞ÊèêÈÜí"
          }
        },
        extraInfo: {
          "studentName": studentName,
          "classTime": time
        }
      };
      await notificationManager.publish(notificationRequest);
      try { promptAction.showToast({ message: 'Â∑≤ÂèëÈÄÅ‰∏äËØæÊèêÈÜíÈÄöÁü•' }); } catch (e) {}
    } catch (err) {
      console.error(`ÂèëÂ∏ÉÈÄöÁü•Â§±Ë¥•: ${JSON.stringify(err)}`);
      try { promptAction.showToast({ message: 'ÈÄöÁü•ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê' }); } catch (e) {}
    }
  }
}

// --- 3. UI ÁªÑ‰ª∂ ---

// ÂºπÁ™óÊ†∑ÂºèÁªÑ‰ª∂
@CustomDialog
struct AddDialog {
  controller: CustomDialogController;
  type: 'class' | 'inspiration' | 'student_add' = 'class';
  @Link students: Student[];
  @Link events: CalendarEvent[];
  selectedDate: Date = new Date();

  @State nameInput: string = '';
  @State hoursInput: string = '';
  @State noteInput: string = '';
  @State selectedStudentIds: number[] = []; 
  @State timeInput: string = '10:00'; 
  @State contentInput: string = '';

  build() {
    Column() {
      // Ê†áÈ¢òÊ†è
      Text(this.type === 'class' ? 'Êéí‰∏ÄËäÇËØæ' : (this.type === 'inspiration' ? 'ËÆ∞ÂΩïÁÅµÊÑü' : 'Êñ∞Â¢ûÂ≠¶Áîü'))
        .fontSize(24) 
        .fontWeight(FontWeight.Bold)
        .fontColor('#111827')
        .margin({ bottom: 20, top: 8 })
        .width('100%')
        .textAlign(TextAlign.Start)

      if (this.type === 'student_add') {
        // Â≠¶ÁîüÊ∑ªÂä†Ë°®Âçï
        Column({ space: 16 }) {
          TextInput({ placeholder: 'Â≠¶ÁîüÂßìÂêç', text: this.nameInput })
            .backgroundColor('#F3F4F6')
            .placeholderColor('#9CA3AF')
            .borderRadius(12)
            .height(50)
            .padding({ left: 16 })
            .width('100%')
            .onChange((val) => this.nameInput = val)

          TextInput({ placeholder: 'Ë¥≠‰π∞ËØæÊó∂', text: this.hoursInput })
            .type(InputType.Number)
            .backgroundColor('#F3F4F6')
            .placeholderColor('#9CA3AF')
            .borderRadius(12)
            .height(50)
            .padding({ left: 16 })
            .width('100%')
            .onChange((val) => this.hoursInput = val)

          TextInput({ placeholder: 'Â§áÊ≥® (ÈÄâÂ°´)', text: this.noteInput })
            .backgroundColor('#F3F4F6')
            .placeholderColor('#9CA3AF')
            .borderRadius(12)
            .height(50)
            .padding({ left: 16 })
            .width('100%')
            .onChange((val) => this.noteInput = val)
        }
      } else if (this.type === 'class') {
        // ÊéíËØæË°®Âçï
        Column({ space: 12 }) {
          Text('ÈÄâÊã©Â≠¶Áîü:').fontSize(14).fontColor('#6B7280').width('100%').margin({ bottom: 4 })
          if (this.students.length === 0) {
            Text('ÊöÇÊó†Â≠¶ÁîüÊï∞ÊçÆÔºåËØ∑ÂÖàÂéª‚ÄúÂ≠¶Áîü‚ÄùÈ°µÊ∑ªÂä†').fontSize(14).fontColor('#2563EB').backgroundColor('#EFF6FF').padding(12).borderRadius(12).width('100%')
          } else {
            // ÂçïÈÄâÈÄªËæë
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.students, (s: Student) => {
                Text(s.name)
                  .fontSize(14)
                  .fontWeight(this.selectedStudentIds.includes(s.id) ? FontWeight.Bold : FontWeight.Normal)
                  .fontColor(this.selectedStudentIds.includes(s.id) ? Color.White : '#374151')
                  .padding({ left: 16, right: 16, top: 10, bottom: 10 })
                  .backgroundColor(this.selectedStudentIds.includes(s.id) ? '#2563EB' : '#F3F4F6')
                  .borderRadius(24)
                  .margin({ right: 12, bottom: 12 })
                  .onClick(() => {
                     // ÊÅ¢Â§çÂ§öÈÄâÈÄªËæëÔºåÊñπ‰æøÊâπÈáèÊéíËØæ
                     if (this.selectedStudentIds.includes(s.id)) {
                       this.selectedStudentIds = this.selectedStudentIds.filter(id => id !== s.id);
                     } else {
                       this.selectedStudentIds.push(s.id);
                     }
                  })
              })
            }
            .margin({ bottom: 8 })
          }
          TextInput({ text: this.timeInput, placeholder: 'ÈÄâÊã©Êó∂Èó¥' })
            .backgroundColor('#F9FAFB')
            .fontColor('#000000') 
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .textAlign(TextAlign.Center)
            .borderRadius(16)
            .height(56)
            .onChange((val: string) => this.timeInput = val)
            .width('100%')
        }
      } else {
        // ÁÅµÊÑüË°®Âçï
        TextArea({ placeholder: 'ÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï...' })
          .height(120)
          .backgroundColor('#F3F4F6')
          .borderRadius(16)
          .onChange((val: string) => this.contentInput = val)
          .padding(16)
      }

      // Â∫ïÈÉ®ÊåâÈíÆÂå∫
      Row({ space: 16 }) {
        Button('ÂèñÊ∂à')
          .backgroundColor('#F3F4F6')
          .fontColor('#4B5563')
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => this.controller.close())
        
        Button('Á°ÆËÆ§')
          .backgroundColor('#2563EB')
          .fontColor(Color.White)
          .layoutWeight(1)
          .height(48)
          .borderRadius(24)
          .onClick(() => this.handleSubmit())
      }
      .margin({ top: 32 })
      .width('100%')
    }
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(24)
    .width('90%')
  }

  handleSubmit() {
    if (this.type === 'student_add') {
      if (!this.nameInput) {
        try { promptAction.showToast({ message: 'ËØ∑ËæìÂÖ•ÂßìÂêç' }); } catch(e){}
        return;
      }
      this.students.push(new Student(this.nameInput, parseInt(this.hoursInput) || 0, this.noteInput));
    } else if (this.type === 'class') {
      if (this.selectedStudentIds.length === 0) { 
        try { promptAction.showToast({ message: 'ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰ΩçÂ≠¶Áîü' }); } catch(e){} 
        return; 
      }
      this.selectedStudentIds.forEach(id => {
        const evt = new CalendarEvent('class', this.selectedDate.toISOString().split('T')[0]);
        evt.studentId = id;
        evt.time = this.timeInput;
        this.events.push(evt);
      });
    } else {
      if (!this.contentInput) return;
      const evt = new CalendarEvent('inspiration', this.selectedDate.toISOString().split('T')[0]);
      evt.content = this.contentInput;
      this.events.push(evt);
    }
    this.controller.close();
  }
}

@Entry
@Component
struct ClassRecorderApp {
  @StorageLink('students_data') students: Student[] = [];
  @StorageLink('events_data') events: CalendarEvent[] = [];

  // È°µÈù¢ÊéßÂà∂Áä∂ÊÄÅ
  @State currentTabIndex: number = 0;
  private tabsController: TabsController = new TabsController();

  @State currentDate: Date = new Date();
  @State selectedDate: Date = new Date();
  @State isSheetShown: boolean = false;
  @State dialogType: 'class' | 'inspiration' | 'student_add' = 'class';

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddDialog({ type: this.dialogType, students: $students, events: $events, selectedDate: this.selectedDate }),
    alignment: DialogAlignment.Center, 
    customStyle: true,
    autoCancel: true
  });

  // 1. Áä∂ÊÄÅÊ†è‰øÆÂ§çÔºöËÆæÁΩÆÂÖ®ÈÄèÊòéËÉåÊôØ
  setStatusBar() {
    window.getLastWindow(getContext(this)).then((win) => {
      win.setWindowSystemBarProperties({
        statusBarColor: '#00FFFFFF', // ÈÄèÊòéËÉåÊôØ
        statusBarContentColor: '#000000', // ÈªëËâ≤ÂõæÊ†á
        navigationBarColor: '#FFFFFF',
        navigationBarContentColor: '#000000'
      })
    }).catch((err: Error) => {
      console.error('Failed to set window properties: ' + JSON.stringify(err));
    });
  }

  aboutToAppear() {
    this.setStatusBar();
  }

  onPageShow() {
    this.setStatusBar();
  }

  openDialog(type: 'class' | 'inspiration' | 'student_add') {
    this.dialogType = type;
    this.dialogController.open();
  }

  getDaysInMonth(date: Date): (Date | null)[] {
    const year = date.getFullYear();
    const month = date.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay();
    const days: (Date | null)[] = [];
    for (let i = 0; i < firstDayIndex; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
    return days;
  }

  formatDate(date: Date): string { return date.toISOString().split('T')[0]; }
  getEventsForDay(date: Date | null): CalendarEvent[] {
    if (!date) return [];
    return this.events.filter(e => e.date === this.formatDate(date));
  }

  // --- È¶ñÈ°µÊó•ÂéÜËßÜÂõæ ---
  @Builder CalendarView() {
    Column() {
      // È°∂ÈÉ®Ê†áÈ¢ò
      Row() {
        Text('ËØæÊó∂ËÆ∞')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#111827')
        
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 40, height: 40 }).fill('#F3F4F6')
          Text('User').fontSize(10).fontColor('#9CA3AF')
        }.width(40).height(40)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 24, right: 24, top: 20, bottom: 10 })

      // Êúà‰ªΩÂàáÊç¢
      Row() {
        Button('<').type(ButtonType.Normal).backgroundColor(Color.Transparent).fontColor('#6B7280').onClick(() => this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1))
        Column() {
          Text(`${this.currentDate.getMonth() + 1}Êúà`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
          Text(`${this.currentDate.getFullYear()}`).fontSize(12).fontColor('#9CA3AF').letterSpacing(1)
        }.alignItems(HorizontalAlign.Center).margin({ left: 20, right: 20 })
        Button('>').type(ButtonType.Normal).backgroundColor(Color.Transparent).fontColor('#6B7280').onClick(() => this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1))
      }.width('100%').justifyContent(FlexAlign.Center).margin({ top: 10, bottom: 20 })

      // ÊòüÊúü
      Flex({ justifyContent: FlexAlign.SpaceAround }) {
        ForEach(['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'], (day: string) => { 
          Text(day).fontSize(12).fontColor('#9CA3AF').fontWeight(FontWeight.Medium) 
        })
      }.padding({ left: 10, right: 10 }).margin({ bottom: 10 })

      // Êó•ÂéÜÁΩëÊ†º
      Grid() {
        ForEach(this.getDaysInMonth(this.currentDate), (date: Date | null) => {
          GridItem() {
            if (date) {
              Column() {
                Text(`${date.getDate()}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.formatDate(date) === this.formatDate(new Date()) ? Color.White : '#1F2937')
                  .width(40).height(40).textAlign(TextAlign.Center).borderRadius(20)
                  .backgroundColor(this.formatDate(date) === this.formatDate(new Date()) ? '#2563EB' : Color.Transparent)
                Row({ space: 4 }) {
                  if (this.getEventsForDay(date).some(e => e.type === 'class')) Circle({ width: 5, height: 5 }).fill('#3B82F6')
                  if (this.getEventsForDay(date).some(e => e.type === 'inspiration')) Circle({ width: 5, height: 5 }).fill('#F97316')
                }.margin({ top: 4 })
              }
              .height(64).width('100%').justifyContent(FlexAlign.Start)
              .onClick(() => { this.selectedDate = date; this.isSheetShown = true; })
            }
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr')
      .rowsGap(8).padding({ left: 10, right: 10 }).layoutWeight(1)

      // ‰ªäÊó•Ê¶ÇËßàÂÖ•Âè£
      Row() {
        Column() {
          Text('‰ªäÊó•Ê¶ÇËßà').fontSize(12).fontColor('#3B82F6').fontWeight(FontWeight.Bold).margin({ bottom: 4 })
          Text(`${this.getEventsForDay(new Date()).length} È°πÊó•Á®ã`).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#1F2937')
        }.alignItems(HorizontalAlign.Start)
        // ‰øÆÂ§çÔºöÊõøÊç¢Á≥ªÁªüÂõæÊ†áËµÑÊ∫ê‰∏∫ÊôÆÈÄö Text
        Text('üìÖ').fontSize(30)
      }
      .width('90%').backgroundColor('#EFF6FF').borderRadius(20).padding(24)
      .justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })
      .onClick(() => { this.selectedDate = new Date(); this.isSheetShown = true; })
    }
    .height('100%').backgroundColor(Color.White)
  }

  // --- Â≠¶ÁîüÁÆ°ÁêÜËßÜÂõæ ---
  @Builder StudentsView() {
    Column() {
      Row() {
        Text('Â≠¶ÁîüÁÆ°ÁêÜ').fontSize(24).fontWeight(FontWeight.Bold)
        Button('+ Êñ∞Â¢û').height(36).fontSize(14).backgroundColor('#2563EB').onClick(() => this.openDialog('student_add'))
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ left: 24, right: 24, top: 20, bottom: 20 })

      List({ space: 12 }) {
        ForEach(this.students, (student: Student, index: number) => {
          ListItem() {
            Row() {
              Text(student.name.substring(0, 1)).width(48).height(48).fontSize(20).fontWeight(FontWeight.Bold).textAlign(TextAlign.Center).fontColor('#4B5563').backgroundColor('#F3F4F6').borderRadius(24).margin({ right: 16 })
              Column() {
                Row() {
                  Text(student.name).fontSize(16).fontWeight(FontWeight.Bold)
                  if (student.remainingHours <= 3) {
                    Text('‰ΩôÈ¢ù‰∏çË∂≥').fontSize(10).fontColor('#DC2626').backgroundColor('#FEE2E2').padding({ left: 6, right: 6, top: 2, bottom: 2 }).borderRadius(4).margin({ left: 8 })
                  }
                }
                Text(student.note || 'Êó†Â§áÊ≥®').fontSize(12).fontColor('#9CA3AF').margin({ top: 4 })
              }.alignItems(HorizontalAlign.Start).layoutWeight(1)
              Column() {
                Text('Ââ©‰Ωô').fontSize(10).fontColor('#9CA3AF')
                Text() { Span(`${student.remainingHours}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(student.remainingHours <= 3 ? '#EF4444' : '#2563EB'); Span(` / ${student.totalHours}`).fontSize(12).fontColor('#9CA3AF') }
              }
            }.padding(16).width('100%').backgroundColor(Color.White).borderRadius(16).shadow({ radius: 10, color: 'rgba(0,0,0,0.03)', offsetY: 4 })
          }.swipeAction({ end: this.DeleteAction(index, 'student') })
        })
      }.width('100%').padding({ left: 16, right: 16, bottom: 100 }).layoutWeight(1)
    }.height('100%').backgroundColor('#F9FAFB')
  }

  @Builder DeleteAction(key: number, type: 'student' | 'event_id') {
    Button('Âà†Èô§').type(ButtonType.Normal).backgroundColor('#EF4444').fontColor(Color.White).width(80).height('100%').onClick(() => { 
      animateTo({ duration: 300 }, () => { 
        if (type === 'student') this.students.splice(key, 1); 
        else this.events = this.events.filter(e => e.id !== key);
      }) 
    })
  }

  // --- ËØ¶ÊÉÖÈ°µÔºöÂçïÂàóÂç°Áâá List ---
  @Builder SheetContent() {
    Column() {
      // Â§¥ÈÉ®
      Row() {
        Text(`${this.selectedDate.getMonth() + 1}Êúà${this.selectedDate.getDate()}Êó•`)
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#111827')
        Button('‚úï').type(ButtonType.Circle).backgroundColor('#F3F4F6').fontColor('#6B7280').width(32).height(32).fontSize(14).onClick(() => this.isSheetShown = false)
      }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 20 })

      // ÊåâÈíÆÁªÑ
      Row({ space: 12 }) {
        Button() { Row() { Text('üë§').fontSize(16).margin({ right: 8 }); Text('Êéí‰∏ÄËäÇËØæ').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#2563EB') } }
        .backgroundColor('#EFF6FF').type(ButtonType.Normal).borderRadius(16).layoutWeight(1).height(56)
        .onClick(() => { this.isSheetShown = false; this.openDialog('class'); })

        Button() { Row() { Text('üí°').fontSize(16).margin({ right: 8 }); Text('ËÆ∞‰∏™ÁÅµÊÑü').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#EA580C') } }
        .backgroundColor('#FFF7ED').type(ButtonType.Normal).borderRadius(16).layoutWeight(1).height(56)
        .onClick(() => { this.isSheetShown = false; this.openDialog('inspiration'); })
      }.margin({ bottom: 24 })

      // ÂçïÂàóÂç°ÁâáÂàóË°®
      List({ space: 12 }) {
        ForEach(this.getEventsForDay(this.selectedDate), (ev: CalendarEvent) => {
          ListItem() {
            if (ev.type === 'class') {
              // ËØæÁ®ãÂç°Áâá (ËìùËâ≤Á≥ª)
              Column() {
                // È°∂ÈÉ®ÔºöÊó∂Èó¥
                Row() {
                  Text(ev.time).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#1E3A8A')
                  if (ev.status === 'completed') {
                    Text('Â∑≤ÂÆåÊàê').fontSize(12).fontColor('#059669').backgroundColor('#D1FAE5').padding({left:8, right:8, top:4, bottom:4}).borderRadius(6)
                  }
                }.width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 8 })
                
                // ‰∏≠ÈÉ®ÔºöÂ≠¶ÁîüÂßìÂêç
                Text(this.students.find(s => s.id === ev.studentId)?.name || 'Êú™Áü•Â≠¶Áîü')
                  .fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1F2937').margin({ bottom: 4 })
                Text('‰∏ÄÂØπ‰∏ÄËØæÁ®ã').fontSize(14).fontColor('#6B7280').margin({ bottom: 16 })

                // Â∫ïÈÉ®Êìç‰ΩúÊ†è (ÊñáÂ≠ó+Ëâ≤ÂùóÊåâÈíÆ)
                Row() {
                  if (ev.status !== 'completed') {
                    // ÊèêÈÜíÊåâÈíÆ (ÊñáÂ≠ó+Ëâ≤Âùó)
                    Button() {
                      Row() {
                        Text('üîî').fontSize(14).margin({ right: 6 })
                        Text('ÊèêÈÜí').fontSize(14).fontColor(Color.White).fontWeight(FontWeight.Medium)
                      }
                    }
                    .height(36)
                    .backgroundColor('#3B82F6') // ËìùËâ≤
                    .type(ButtonType.Normal)
                    .borderRadius(18) // ËÉ∂ÂõäÂúÜËßí
                    .padding({ left: 16, right: 16 })
                    .margin({ right: 12 })
                    .onClick(() => {
                       const sName = this.students.find(s => s.id === ev.studentId)?.name || 'Â≠¶Áîü';
                       NotificationService.startClassReminder(sName, ev.time);
                    })

                    // ÂÆåÊàêÊåâÈíÆ (ÊñáÂ≠ó+Ëâ≤Âùó)
                    Button() {
                      Row() {
                        Text('‚úÖ').fontSize(14).margin({ right: 6 })
                        Text('ÂÆåÊàê').fontSize(14).fontColor(Color.White).fontWeight(FontWeight.Medium)
                      }
                    }
                    .height(36)
                    .backgroundColor('#10B981') // ÁªøËâ≤
                    .type(ButtonType.Normal)
                    .borderRadius(18)
                    .padding({ left: 16, right: 16 })
                    .onClick(() => {
                       const evtIndex = this.events.findIndex(e => e.id === ev.id);
                       if (evtIndex !== -1) { this.events[evtIndex].status = 'completed'; this.events = [...this.events]; }
                       const stuIndex = this.students.findIndex(s => s.id === ev.studentId);
                       if (stuIndex !== -1) { 
                         let uS = this.students[stuIndex]; uS.remainingHours -= 1; 
                         this.students[stuIndex] = uS; this.students = [...this.students]; 
                       }
                    })
                  }
                  
                  Blank() // ÊíëÂºÄÈó¥Ë∑ù
                  
                  // Âà†Èô§ (ÊîæÂú®ÊúÄÂè≥‰æß)
                  Button() {
                    Text('üóëÔ∏è').fontSize(18)
                  }
                  .backgroundColor('transparent')
                  .onClick(() => this.events = this.events.filter(e => e.id !== ev.id))
                }.width('100%').alignItems(VerticalAlign.Center)
              }
              .padding(16)
              .borderRadius(16)
              .backgroundColor(ev.status === 'completed' ? '#F9FAFB' : '#E0F2F1') // ÂÆåÊàêÂèòÁÅ∞ÔºåÊú™ÂÆåÊàêÊ∑°Ëìù
              .width('100%')
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 4 })
            } else {
              // ÁÅµÊÑüÂç°Áâá (ÊöñËâ≤Á≥ª)
              Column() {
                Text(ev.content).fontSize(16).fontColor('#4B5563').lineHeight(24)
                Row() {
                  Text(ev.time || 'ÂÖ®Â§©').fontSize(12).fontColor('#9CA3AF')
                  Blank()
                  Text('üóëÔ∏è').fontSize(18)
                    .onClick(() => this.events = this.events.filter(e => e.id !== ev.id))
                }.width('100%').margin({ top: 16 }).alignItems(VerticalAlign.Bottom)
              }
              .padding(20)
              .borderRadius(16)
              .backgroundColor('#FFF8E1') // ÊüîÂíåÊ©ôÈªÑ
              .width('100%')
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 4 })
            }
          }
        }, (item: CalendarEvent) => item.id.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .padding(24)
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Tabs({ controller: this.tabsController, barPosition: BarPosition.End }) {
        TabContent() { this.CalendarView() } 
        TabContent() { this.StudentsView() } // ÁßªÈô§ÁÅµÊÑü Tab, ‰øùÊåÅ 2 ‰∏™ Tab + Â∫ïÈÉ®Ê†è
      }
      .barHeight(0).scrollable(false).backgroundColor(Color.White) 

      Row() {
        this.CustomTabItem(0, 'Êó•ÂéÜ', 'üìÖ')
        Column().layoutWeight(1).height('100%')
        this.CustomTabItem(1, 'Â≠¶Áîü', 'üë•')
      }
      .width('100%').height(60).backgroundColor(Color.White).shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: -5 })

      Button('+').width(56).height(56).fontSize(32).fontWeight(FontWeight.Lighter).backgroundColor('#2563EB')
        .position({ x: '50%', y: '100%' }).markAnchor({ x: '50%', y: 80 }) 
        .shadow({ radius: 10, color: 'rgba(37, 99, 235, 0.4)', offsetY: 5 })
        .onClick(() => { this.selectedDate = new Date(); this.openDialog('class'); })
    }
    .width('100%').height('100%').backgroundColor(Color.White)
    .bindSheet($$this.isSheetShown, this.SheetContent(), { height: SheetSize.MEDIUM, dragBar: false, backgroundColor: Color.White })
  }

  @Builder CustomTabItem(index: number, name: string, icon: string) {
    Column() {
      Text(icon).fontSize(20).margin({ bottom: 4 }).opacity(this.currentTabIndex === index ? 1 : 0.4)
      Text(name).fontColor(this.currentTabIndex === index ? '#111827' : '#9CA3AF').fontSize(10).fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
    }.justifyContent(FlexAlign.Center).height('100%').layoutWeight(1)
    .onClick(() => { this.currentTabIndex = index; this.tabsController.changeIndex(index); })
  }
}
